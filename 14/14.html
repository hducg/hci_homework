<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¤šå½©æ—¥è®° - è®°å½•ç”Ÿæ´»çš„æ¯ä¸€åˆ»</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- é…ç½®Tailwindè‡ªå®šä¹‰ä¸»é¢˜ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#EC4899',
                        neutral: '#F3F4F6',
                        dark: '#1F2937'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                },
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }

            .diary-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }

            .toolbar-item {
                @apply p-2 rounded-full hover:bg-gray-100 transition-all duration-200 cursor-pointer;
            }

                .toolbar-item.active {
                    @apply bg-primary/10 text-primary;
                }

            .emoji-btn {
                @apply text-2xl p-1 rounded hover:bg-gray-100 transition-all cursor-pointer;
            }

            .animate-fade-in {
                animation: fadeIn 0.3s ease-in-out;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }

                to {
                    opacity: 1;
                }
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-50 min-h-screen font-sans text-dark">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- å¤´éƒ¨æ ‡é¢˜ -->
        <header class="mb-8 text-center">
            <h1 class="text-[clamp(1.8rem,5vw,2.5rem)] font-bold text-primary mb-2">å¤šå½©æ—¥è®°</h1>
            <p class="text-gray-500">è®°å½•ç”Ÿæ´»çš„æ¯ä¸€ä¸ªç²¾å½©ç¬é—´</p>
        </header>

        <!-- æ—¥è®°å¡ç‰‡ -->
        <div class="bg-white rounded-2xl diary-shadow p-6 mb-8 transition-all duration-300 hover:shadow-lg">
            <!-- åŸºæœ¬ä¿¡æ¯åŒº -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="space-y-3">
                    <div>
                        <label for="time" class="block text-sm font-medium text-gray-700 mb-1">æ—¶é—´</label>
                        <input type="datetime-local" id="time" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all" />
                    </div>

                    <div>
                        <label for="location" class="block text-sm font-medium text-gray-700 mb-1">åœ°ç‚¹</label>
                        <div class="relative">
                            <input type="text" id="location" placeholder="è¾“å…¥åœ°ç‚¹æˆ–ç‚¹å‡»è·å–ä½ç½®" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all" />
                            <i class="fa fa-map-marker absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <button onclick="getLocation()" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-primary hover:underline">è·å–ä½ç½®</button>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <div>
                        <label for="weather" class="block text-sm font-medium text-gray-700 mb-1">å¤©æ°”</label>
                        <select id="weather" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all appearance-none bg-white">
                            <option value="â˜€ï¸ æ™´">â˜€ï¸ æ™´</option>
                            <option value="â›… å¤šäº‘">â›… å¤šäº‘</option>
                            <option value="ğŸŒ§ï¸ é›¨">ğŸŒ§ï¸ é›¨</option>
                            <option value="ğŸŒ¨ï¸ é›ª">ğŸŒ¨ï¸ é›ª</option>
                            <option value="ğŸŒ©ï¸ é›·æš´">ğŸŒ©ï¸ é›·æš´</option>
                            <option value="ğŸŒ«ï¸ é›¾">ğŸŒ«ï¸ é›¾</option>
                        </select>
                    </div>

                    <div>
                        <label for="mood" class="block text-sm font-medium text-gray-700 mb-1">å¿ƒæƒ…</label>
                        <select id="mood" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all appearance-none bg-white">
                            <option value="ğŸ˜Š å¼€å¿ƒ">ğŸ˜Š å¼€å¿ƒ</option>
                            <option value="ğŸ˜Œ å¹³é™">ğŸ˜Œ å¹³é™</option>
                            <option value="ğŸ˜” éš¾è¿‡">ğŸ˜” éš¾è¿‡</option>
                            <option value="ğŸ˜  ç”Ÿæ°”">ğŸ˜  ç”Ÿæ°”</option>
                            <option value="ğŸ˜² æƒŠè®¶">ğŸ˜² æƒŠè®¶</option>
                            <option value="ğŸ˜ çˆ±æ…•">ğŸ˜ çˆ±æ…•</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- æ—¥è®°å†…å®¹åŒº -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥è®°å†…å®¹</label>
                <div id="diary-content" contenteditable="true" class="min-h-[200px] w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all bg-neutral/50" placeholder="å¼€å§‹è®°å½•ä½ çš„æƒ³æ³•..."></div>
            </div>

            <!-- å·¥å…·æ  -->
            <div class="flex flex-wrap items-center gap-1 py-2 mb-6 border-y border-gray-200">
                <p class="text-sm text-gray-500 mr-2">æ’å…¥:</p>

                <!-- æ–‡æœ¬æ ¼å¼å·¥å…· -->
                <div class="flex items-center gap-1 mr-2">
                    <button class="toolbar-item" title="åŠ ç²—" onclick="formatText('bold')">
                        <i class="fa fa-bold"></i>
                    </button>
                    <button class="toolbar-item" title="æ–œä½“" onclick="formatText('italic')">
                        <i class="fa fa-italic"></i>
                    </button>
                    <button class="toolbar-item" title="ä¸‹åˆ’çº¿" onclick="formatText('underline')">
                        <i class="fa fa-underline"></i>
                    </button>
                </div>

                <!-- æ’å…¥å›¾ç‰‡ -->
                <label class="toolbar-item" title="æ’å…¥å›¾ç‰‡">
                    <i class="fa fa-image"></i>
                    <input type="file" id="imageInput" accept="image/*" onchange="insertImage()" class="hidden" />
                </label>

                <!-- å½•éŸ³åŠŸèƒ½ -->
                <button class="toolbar-item" title="å½•éŸ³" id="recordBtn" onclick="toggleRecording()">
                    <i class="fa fa-microphone"></i>
                </button>

                <!-- æ¶‚é¸¦åŠŸèƒ½ -->
                <button class="toolbar-item" title="æ¶‚é¸¦" onclick="toggleDoodlePanel()">
                    <i class="fa fa-paint-brush"></i>
                </button>

                <!-- è¡¨æƒ…æŒ‰é’® -->
                <button class="toolbar-item" title="è¡¨æƒ…" onclick="toggleEmojiPanel()">
                    <i class="fa fa-smile-o"></i>
                </button>

                <!-- æ ‡ç­¾åŠŸèƒ½ -->
                <button class="toolbar-item" title="æ·»åŠ æ ‡ç­¾" onclick="addTag()">
                    <i class="fa fa-tag"></i>
                </button>
            </div>

            <!-- è¡¨æƒ…é¢æ¿ -->
            <div id="emojiPanel" class="hidden mb-6 p-3 bg-neutral rounded-lg animate-fade-in">
                <div class="flex flex-wrap gap-2">
                    <span class="emoji-btn" onclick="insertEmoji('ğŸ˜Š')">ğŸ˜Š</span>
                    <span class="emoji-btn" onclick="insertEmoji('ğŸ˜‚')">ğŸ˜‚</span>
                    <span class="emoji-btn" onclick="insertEmoji('ğŸ˜')">ğŸ˜</span>
                    <span class="emoji-btn" onclick="insertEmoji('â¤ï¸')">â¤ï¸</span>
                    <span class="emoji-btn" onclick="insertEmoji('ğŸ‘')">ğŸ‘</span>
                    <span class="emoji-btn" onclick="insertEmoji('ğŸ‰')">ğŸ‰</span>
                    <span class="emoji-btn" onclick="insertEmoji('ğŸ˜¢')">ğŸ˜¢</span>
                    <span class="emoji-btn" onclick="insertEmoji('ğŸ˜ ')">ğŸ˜ </span>
                    <span class="emoji-btn" onclick="insertEmoji('ğŸ˜²')">ğŸ˜²</span>
                    <span class="emoji-btn" onclick="insertEmoji('ğŸ‘')">ğŸ‘</span>
                    <span class="emoji-btn" onclick="insertEmoji('ğŸ™')">ğŸ™</span>
                    <span class="emoji-btn" onclick="insertEmoji('ğŸ˜´')">ğŸ˜´</span>
                    <span class="emoji-btn" onclick="insertEmoji('ğŸ˜‹')">ğŸ˜‹</span>
                    <span class="emoji-btn" onclick="insertEmoji('ğŸ¤”')">ğŸ¤”</span>
                    <span class="emoji-btn" onclick="insertEmoji('ğŸŒŸ')">ğŸŒŸ</span>
                </div>
            </div>

            <!-- æ¶‚é¸¦é¢æ¿ -->
            <div id="doodlePanel" class="hidden mb-6 animate-fade-in">
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <canvas id="canvas" width="400" height="250" class="border border-gray-300 rounded-lg cursor-crosshair bg-white"></canvas>
                    <div class="flex flex-col gap-2 w-full md:w-auto">
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="setDrawingColor('#000000')" class="w-8 h-8 rounded-full bg-black border-2 border-white shadow"></button>
                            <button onclick="setDrawingColor('#FF0000')" class="w-8 h-8 rounded-full bg-red-500 border-2 border-white shadow"></button>
                            <button onclick="setDrawingColor('#00FF00')" class="w-8 h-8 rounded-full bg-green-500 border-2 border-white shadow"></button>
                            <button onclick="setDrawingColor('#0000FF')" class="w-8 h-8 rounded-full bg-blue-500 border-2 border-white shadow"></button>
                            <button onclick="setDrawingColor('#FFFF00')" class="w-8 h-8 rounded-full bg-yellow-500 border-2 border-white shadow"></button>
                            <button onclick="setDrawingColor('#FF00FF')" class="w-8 h-8 rounded-full bg-purple-500 border-2 border-white shadow"></button>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="setLineWidth(2)" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50">ç»†</button>
                            <button onclick="setLineWidth(5)" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50">ä¸­</button>
                            <button onclick="setLineWidth(10)" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50">ç²—</button>
                        </div>
                        <button onclick="clearCanvas()" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50">æ¸…é™¤</button>
                        <button onclick="insertDoodle()" class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/90 transition-colors">æ’å…¥æ¶‚é¸¦</button>
                    </div>
                </div>
            </div>

            <!-- å½•éŸ³çŠ¶æ€æŒ‡ç¤º -->
            <div id="recordingIndicator" class="hidden mb-6 p-3 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                <span class="text-red-600 text-sm">æ­£åœ¨å½•éŸ³...</span>
                <span id="recordingTime" class="ml-auto text-sm text-gray-500">00:00</span>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="flex flex-wrap gap-3 justify-end">
                <button onclick="clearAll()" class="px-5 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">æ¸…ç©º</button>
                <button onclick="saveDiary()" class="px-5 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors flex items-center gap-2">
                    <i class="fa fa-save"></i> ä¿å­˜æ—¥è®°
                </button>
            </div>
        </div>

        <!-- ä¿å­˜çš„æ—¥è®°åˆ—è¡¨ -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <i class="fa fa-history text-primary"></i> å†å²è®°å½•
            </h2>
            <div id="diaryList" class="space-y-4">
                <!-- å†å²è®°å½•å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                <p class="text-gray-500 text-center py-6">æš‚æ— ä¿å­˜çš„æ—¥è®°</p>
            </div>
        </div>

        <!-- é¡µè„š -->
        <footer class="text-center text-gray-500 text-sm py-4">
            <p>å¤šå½©æ—¥è®° &copy; 2023 - è®°å½•ç”Ÿæ´»çš„ç¾å¥½ç¬é—´</p>
        </footer>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let drawing = false;
        let currentColor = '#000000';
        let lineWidth = 2;
        let mediaRecorder;
        let recording = false;
        let recordingStartTime;
        let recordingTimer;
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const diaryContent = document.getElementById("diary-content");

        // åˆå§‹åŒ–
        window.onload = () => {
            // è®¾ç½®å½“å‰æ—¶é—´
            const now = new Date();
            const localTime = now.toISOString().slice(0, 16);
            document.getElementById("time").value = localTime;

            // åˆå§‹åŒ–ç”»å¸ƒ
            initCanvas();

            // åŠ è½½ä¿å­˜çš„æ—¥è®°
            loadDiaries();
        };

        // åˆå§‹åŒ–ç”»å¸ƒ
        function initCanvas() {
            // æ”¯æŒè§¦æ‘¸è®¾å¤‡
            canvas.addEventListener("mousedown", startDrawing);
            canvas.addEventListener("mouseup", stopDrawing);
            canvas.addEventListener("mouseout", stopDrawing);
            canvas.addEventListener("mousemove", draw);

            canvas.addEventListener("touchstart", (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                startDrawing({ offsetX: x, offsetY: y });
            });

            canvas.addEventListener("touchend", (e) => {
                e.preventDefault();
                stopDrawing();
            });

            canvas.addEventListener("touchmove", (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                draw({ offsetX: x, offsetY: y });
            });
        }

        // ç”»å¸ƒç»˜åˆ¶å‡½æ•°
        function startDrawing(e) {
            drawing = true;
            ctx.beginPath();
            ctx.arc(e.offsetX, e.offsetY, lineWidth / 2, 0, Math.PI * 2);
            ctx.fillStyle = currentColor;
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        }

        function stopDrawing() {
            if (drawing) {
                ctx.closePath();
                drawing = false;
            }
        }

        function draw(e) {
            if (!drawing) return;

            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = lineWidth;
            ctx.lineCap = "round";
            ctx.lineJoin = "round";
            ctx.stroke();

            // é‡ç½®è·¯å¾„ï¼Œé¿å…è¿ç»­ç»˜åˆ¶
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        }

        // è®¾ç½®ç”»ç¬”é¢œè‰²
        function setDrawingColor(color) {
            currentColor = color;
        }

        // è®¾ç½®ç”»ç¬”å®½åº¦
        function setLineWidth(width) {
            lineWidth = width;
        }

        // æ¸…é™¤ç”»å¸ƒ
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // æ’å…¥æ¶‚é¸¦
        function insertDoodle() {
            const dataURL = canvas.toDataURL();
            insertContent(`<div class="my-3"><img src="${dataURL}" class="max-w-full h-auto rounded-lg shadow-sm"></div>`);
            clearCanvas();
            toggleDoodlePanel();
        }

        // åˆ‡æ¢è¡¨æƒ…é¢æ¿æ˜¾ç¤º
        function toggleEmojiPanel() {
            const panel = document.getElementById("emojiPanel");
            panel.classList.toggle("hidden");
            document.getElementById("doodlePanel").classList.add("hidden");
        }

        // åˆ‡æ¢æ¶‚é¸¦é¢æ¿æ˜¾ç¤º
        function toggleDoodlePanel() {
            const panel = document.getElementById("doodlePanel");
            panel.classList.toggle("hidden");
            document.getElementById("emojiPanel").classList.add("hidden");
        }

        // æ’å…¥è¡¨æƒ…
        function insertEmoji(emoji) {
            insertContent(emoji);
        }

        // æ’å…¥å›¾ç‰‡
        function insertImage() {
            const input = document.getElementById("imageInput");
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                insertContent(`<div class="my-3"><img src="${e.target.result}" class="max-w-full h-auto rounded-lg shadow-sm"></div>`);
            };
            reader.readAsDataURL(file);

            // é‡ç½®è¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            input.value = "";
        }

        // å½•éŸ³åŠŸèƒ½
        function toggleRecording() {
            const recordBtn = document.getElementById("recordBtn");
            const indicator = document.getElementById("recordingIndicator");

            if (!recording) {
                // å¼€å§‹å½•éŸ³
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        mediaRecorder = new MediaRecorder(stream);
                        const audioChunks = [];

                        mediaRecorder.addEventListener("dataavailable", event => {
                            audioChunks.push(event.data);
                        });

                        mediaRecorder.addEventListener("stop", () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                            const audioUrl = URL.createObjectURL(audioBlob);
                            insertContent(`<div class="my-3"><audio controls class="w-full max-w-md"><source src="${audioUrl}" type="audio/wav"> æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚</audio></div>`);

                            // åœæ­¢æ‰€æœ‰è½¨é“
                            stream.getTracks().forEach(track => track.stop());
                        });

                        mediaRecorder.start();
                        recording = true;
                        recordBtn.innerHTML = '<i class="fa fa-stop"></i>';
                        recordBtn.classList.add('active', 'text-red-500');
                        indicator.classList.remove('hidden');

                        // å¼€å§‹è®¡æ—¶
                        recordingStartTime = Date.now();
                        updateRecordingTime();
                    })
                    .catch(error => {
                        console.error("å½•éŸ³æƒé™è¢«æ‹’ç»:", error);
                        alert("æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·ç¡®ä¿å·²æˆäºˆæƒé™ã€‚");
                    });
            } else {
                // åœæ­¢å½•éŸ³
                mediaRecorder.stop();
                recording = false;
                recordBtn.innerHTML = '<i class="fa fa-microphone"></i>';
                recordBtn.classList.remove('active', 'text-red-500');
                indicator.classList.add('hidden');
                clearInterval(recordingTimer);
            }
        }

        // æ›´æ–°å½•éŸ³æ—¶é—´
        function updateRecordingTime() {
            const elapsedTime = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60).toString().padStart(2, '0');
            const seconds = (elapsedTime % 60).toString().padStart(2, '0');
            document.getElementById("recordingTime").textContent = `${minutes}:${seconds}`;

            recordingTimer = setTimeout(updateRecordingTime, 1000);
        }

        // æ–‡æœ¬æ ¼å¼åŒ–
        function formatText(command) {
            document.execCommand(command, false, null);
            diaryContent.focus();
        }

        // æ·»åŠ æ ‡ç­¾
        function addTag() {
            const tag = prompt("è¯·è¾“å…¥æ ‡ç­¾ï¼ˆæ— ç©ºæ ¼ï¼‰:");
            if (tag && tag.trim()) {
                insertContent(`<span class="inline-block px-2 py-0.5 bg-primary/10 text-primary text-sm rounded-full mx-0.5">#${tag.trim()}</span>`);
            }
        }

        // æ’å…¥å†…å®¹åˆ°æ—¥è®°
        function insertContent(content) {
            const selection = window.getSelection();
            if (selection.rangeCount) {
                const range = selection.getRangeAt(0);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;

                while (tempDiv.firstChild) {
                    range.insertNode(tempDiv.firstChild);
                }

                // ç§»åŠ¨å…‰æ ‡åˆ°æ’å…¥å†…å®¹åé¢
                range.setStartAfter(tempDiv.lastChild);
                range.setEndAfter(tempDiv.lastChild);
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                // å¦‚æœæ²¡æœ‰é€‰ä¸­åŒºåŸŸï¼Œç›´æ¥æ·»åŠ åˆ°æœ«å°¾
                diaryContent.innerHTML += content;
            }

            // èšç„¦åˆ°å†…å®¹åŒº
            diaryContent.focus();

            // æ»šåŠ¨åˆ°åº•éƒ¨
            diaryContent.scrollTop = diaryContent.scrollHeight;
        }

        // è·å–åœ°ç†ä½ç½®
        function getLocation() {
            if (navigator.geolocation) {
                const locationInput = document.getElementById("location");
                locationInput.value = "æ­£åœ¨è·å–ä½ç½®...";

                navigator.geolocation.getCurrentPosition(
                    position => {
                        // è¿™é‡Œå¯ä»¥è°ƒç”¨é€†åœ°ç†ç¼–ç APIè·å–å…·ä½“åœ°å€
                        // ç®€åŒ–å¤„ç†ï¼Œç›´æ¥æ˜¾ç¤ºåæ ‡
                        locationInput.value = `çº¬åº¦: ${position.coords.latitude.toFixed(2)}, ç»åº¦: ${position.coords.longitude.toFixed(2)}`;
                    },
                    error => {
                        console.error("è·å–ä½ç½®å¤±è´¥:", error);
                        locationInput.value = "è·å–ä½ç½®å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥";
                    }
                );
            } else {
                alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®åŠŸèƒ½");
            }
        }

        // ä¿å­˜æ—¥è®°
        function saveDiary() {
            const time = document.getElementById("time").value;
            const weather = document.getElementById("weather").value;
            const mood = document.getElementById("mood").value;
            const location = document.getElementById("location").value;
            const content = diaryContent.innerHTML;

            if (!time || !content.trim()) {
                alert("è¯·å¡«å†™æ—¶é—´å’Œæ—¥è®°å†…å®¹");
                return;
            }

            // åˆ›å»ºæ—¥è®°å¯¹è±¡
            const diary = {
                id: Date.now(),
                time,
                weather,
                mood,
                location,
                content,
                createdAt: new Date().toISOString()
            };

            // ä»æœ¬åœ°å­˜å‚¨è·å–ç°æœ‰æ—¥è®°
            let diaries = JSON.parse(localStorage.getItem('diaries') || '[]');

            // æ·»åŠ æ–°æ—¥è®°
            diaries.unshift(diary);

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('diaries', JSON.stringify(diaries));

            // æ›´æ–°æ—¥è®°åˆ—è¡¨
            loadDiaries();

            // æ¸…ç©ºè¡¨å•
            clearAll();

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            alert("æ—¥è®°ä¿å­˜æˆåŠŸï¼");
        }

        // åŠ è½½ä¿å­˜çš„æ—¥è®°
        function loadDiaries() {
            const diaryList = document.getElementById("diaryList");
            const diaries = JSON.parse(localStorage.getItem('diaries') || '[]');

            if (diaries.length === 0) {
                diaryList.innerHTML = '<p class="text-gray-500 text-center py-6">æš‚æ— ä¿å­˜çš„æ—¥è®°</p>';
                return;
            }

            diaryList.innerHTML = '';

            diaries.forEach(diary => {
                // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                const date = new Date(diary.time);
                const formattedDate = date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // åˆ›å»ºæ—¥è®°å¡ç‰‡
                const diaryCard = document.createElement('div');
                diaryCard.className = 'bg-white p-4 rounded-xl diary-shadow hover:shadow-md transition-all';
                diaryCard.innerHTML = `
              <div class="flex justify-between items-start mb-3">
                <div>
                  <h3 class="font-medium">${formattedDate}</h3>
                  <div class="flex gap-4 mt-1 text-sm">
                    <span>${diary.weather}</span>
                    <span>${diary.mood}</span>
                    ${diary.location ? `<span><i class="fa fa-map-marker text-gray-400"></i> ${diary.location}</span>` : ''}
                  </div>
                </div>
                <div class="flex gap-1">
                  <button onclick="editDiary(${diary.id})" class="p-1 text-gray-500 hover:text-primary" title="ç¼–è¾‘">
                    <i class="fa fa-edit"></i>
                  </button>
                  <button onclick="deleteDiary(${diary.id})" class="p-1 text-gray-500 hover:text-red-500" title="åˆ é™¤">
                    <i class="fa fa-trash"></i>
                  </button>
                </div>
              </div>
              <div class="diary-preview text-sm text-gray-700 border-t border-gray-100 pt-3">
                ${diary.content.length > 150 ?
                        `${diary.content.replace(/<[^>]*>?/gm, '').substring(0, 150)}...` :
                        diary.content.replace(/<[^>]*>?/gm, '')}
              </div>
              <button onclick="viewDiary(${diary.id})" class="mt-3 text-primary text-sm hover:underline">æŸ¥çœ‹å…¨æ–‡</button>
            `;

                diaryList.appendChild(diaryCard);
            });
        }

        // æŸ¥çœ‹æ—¥è®°è¯¦æƒ…
        function viewDiary(id) {
            const diaries = JSON.parse(localStorage.getItem('diaries') || '[]');
            const diary = diaries.find(d => d.id === id);

            if (!diary) return;

            // åˆ›å»ºè¯¦æƒ…æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-fade-in';
            modal.innerHTML = `
            <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
              <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                  <h2 class="text-xl font-bold">æ—¥è®°è¯¦æƒ…</h2>
                  <button onclick="this.closest('.fixed').remove()" class="p-2 hover:bg-gray-100 rounded-full">
                    <i class="fa fa-times"></i>
                  </button>
                </div>
                <div class="flex flex-wrap gap-4 mt-3 text-sm">
                  <span><i class="fa fa-clock-o text-gray-400 mr-1"></i> ${new Date(diary.time).toLocaleString()}</span>
                  <span>${diary.weather}</span>
                  <span>${diary.mood}</span>
                  ${diary.location ? `<span><i class="fa fa-map-marker text-gray-400 mr-1"></i> ${diary.location}</span>` : ''}
                </div>
              </div>
              <div class="p-6">
                ${diary.content}
              </div>
            </div>
          `;

            document.body.appendChild(modal);
        }

        // ç¼–è¾‘æ—¥è®°
        function editDiary(id) {
            const diaries = JSON.parse(localStorage.getItem('diaries') || '[]');
            const diaryIndex = diaries.findIndex(d => d.id === id);

            if (diaryIndex === -1) return;

            const diary = diaries[diaryIndex];

            // å¡«å……è¡¨å•
            document.getElementById("time").value = diary.time;
            document.getElementById("weather").value = diary.weather;
            document.getElementById("mood").value = diary.mood;
            document.getElementById("location").value = diary.location;
            diaryContent.innerHTML = diary.content;

            // åˆ é™¤åŸæ—¥è®°
            diaries.splice(diaryIndex, 1);
            localStorage.setItem('diaries', JSON.stringify(diaries));

            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // åˆ é™¤æ—¥è®°
        function deleteDiary(id) {
            if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿ")) {
                let diaries = JSON.parse(localStorage.getItem('diaries') || '[]');
                diaries = diaries.filter(d => d.id !== id);
                localStorage.setItem('diaries', JSON.stringify(diaries));
                loadDiaries();
            }
        }

        // æ¸…ç©ºæ‰€æœ‰å†…å®¹
        function clearAll() {
            if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ")) {
                document.getElementById("time").value = new Date().toISOString().slice(0, 16);
                document.getElementById("weather").selectedIndex = 0;
                document.getElementById("mood").selectedIndex = 0;
                document.getElementById("location").value = "";
                diaryContent.innerHTML = "";
                clearCanvas();
                document.getElementById("emojiPanel").classList.add("hidden");
                document.getElementById("doodlePanel").classList.add("hidden");
            }
        }
    </script>
</body>
</html>
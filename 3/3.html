<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤šåª’ä½“æ—¥è®°åº”ç”¨</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <!-- é¦–é¡µ -->
<div id="home" class="page active">
        <h1>æˆ‘çš„æ—¥è®°æœ¬</h1>
        <div id="å¤§ç›’å­">
            <div id="å†™æ—¥è®°" class="small-box">
                <div class="date" id="home-date">
                  <div id="daytime">27æ—¥</div> <div id="othertime">2025å¹´10æœˆ</div>
                </div>
                <p id="home-content">æ™šé¥­åƒå®Œé›ä¸ªå¼¯è¿åŠ¨è¿åŠ¨ï¼Œä»Šå¤©å¤©æ°”ä¸é”™ï¼Œæ•£æ­¥æ—¶çœ‹åˆ°äº†ç¾ä¸½çš„å¤•é˜³ã€‚</p>
                <div class="image-placeholder1">
                    <img src="./èµ„æº/20190805160051_xhwog.jpg">
                     <div id="button-div"><button  id="record-today">è®°å½•ä»Šå¤©</button></div>
                </div>
            </div>
            
            <div id="æ„Ÿè°¢é™ªä¼´" class="small-box">
                <h2>æ„Ÿè°¢é™ªä¼´</h2>
                <p>æ„Ÿè°¢æ‚¨ä¸€ç›´ä»¥æ¥çš„é™ªä¼´ä¸æ”¯æŒï¼Œè¿™æ®µæ—¶å…‰å› ä¸ºæœ‰æ‚¨è€Œæ›´åŠ ç¾å¥½ã€‚</p>
                <p>ç”Ÿæ´»ä¸­çš„ç‚¹æ»´æ¸©æš–éƒ½å€¼å¾—è¢«è®°å½•å’Œçè—ã€‚</p>
                <div class="image-placeholder2">
                    <img src="./èµ„æº/OIP-C (4).webp" alt="æ„Ÿè°¢é™ªä¼´å›¾ç‰‡">
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ—¥è®°è®°å½•æµç¨‹ - æ”¹ä¸ºæ‚¬æµ®æ¡†å½¢å¼ -->
    <div class="diary-overlay" id="diary-overlay">
      <div class="diary-container" id="diary-flow">
        <div class="progress-bar">
          <div class="progress" id="progress"></div>
        </div>
        
        <!-- æ­¥éª¤1ï¼šé€‰æ‹©å¤©æ°” -->
        <div class="step active" id="step1">
          <h2>ä»Šå¤©å¤©æ°”å¦‚ä½•ï¼Ÿ</h2>
          <div class="options-container">
            <div class="option" data-value="sunny">
              <i class="fas fa-sun weather-icon" style="color: #f39c12;"></i>
              <span>æ™´æœ—</span>
            </div>
            <div class="option" data-value="cloudy">
              <i class="fas fa-cloud weather-icon" style="color: #95a5a6;"></i>
              <span>å¤šäº‘</span>
            </div>
            <div class="option" data-value="rainy">
              <i class="fas fa-cloud-rain weather-icon" style="color: #3498db;"></i>
              <span>é›¨å¤©</span>
            </div>
            <div class="option" data-value="snowy">
              <i class="fas fa-snowflake weather-icon" style="color: #1abc9c;"></i>
              <span>é›ªå¤©</span>
            </div>
            <div class="option" data-value="windy">
              <i class="fas fa-wind weather-icon" style="color: #9b59b6;"></i>
              <span>å¤§é£</span>
            </div>
          </div>
          <div class="button-group">
            <button class="btn-prev" disabled>ä¸Šä¸€æ­¥</button>
            <button class="btn-next" id="next1">ä¸‹ä¸€æ­¥</button>
          </div>
        </div>
        
        <!-- æ­¥éª¤2ï¼šé€‰æ‹©å¿ƒæƒ… -->
        <div class="step" id="step2">
          <h2>ä½ ä»Šå¤©æ„Ÿè§‰å¦‚ä½•ï¼Ÿ</h2>
          <div class="options-container">
            <div class="option" data-value="happy">
              <i class="fas fa-laugh mood-icon" style="color: #f1c40f;"></i>
              <span>å¼€å¿ƒ</span>
            </div>
            <div class="option" data-value="sad">
              <i class="fas fa-sad-tear mood-icon" style="color: #3498db;"></i>
              <span>éš¾è¿‡</span>
            </div>
            <div class="option" data-value="angry">
              <i class="fas fa-angry mood-icon" style="color: #e74c3c;"></i>
              <span>ç”Ÿæ°”</span>
            </div>
            <div class="option" data-value="tired">
              <i class="fas fa-tired mood-icon" style="color: #7f8c8d;"></i>
              <span>ç–²æƒ«</span>
            </div>
            <div class="option" data-value="excited">
              <i class="fas fa-grin-stars mood-icon" style="color: #e67e22;"></i>
              <span>å…´å¥‹</span>
            </div>
          </div>
          <div class="button-group">
            <button class="btn-prev" id="prev2">ä¸Šä¸€æ­¥</button>
            <button class="btn-next" id="next2">ä¸‹ä¸€æ­¥</button>
          </div>
        </div>
        
        <!-- æ­¥éª¤3ï¼šè®°å½•æ—¥è®°å†…å®¹ -->
<div class="step" id="step3">
  <h2>å†™ä¸‹ä»Šå¤©çš„ç»å†</h2>
  <div 
    class="text-input" 
    id="diary-content" 
    contenteditable="true" 
    placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿ"
    style="min-height: 150px; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 20px 0;"
  ></div>
  
  <!-- ä¿®æ”¹åçš„å·¥å…·æ  -->
<div class="toolbar" style="margin: 15px 0;">
  <label>æ’å…¥ï¼š</label>
  <button onclick="insertEmoji('ğŸ˜Š')">ğŸ˜Š</button>
  <button onclick="insertEmoji('ğŸ˜¢')">ğŸ˜¢</button>
  <button onclick="insertEmoji('â¤ï¸')">â¤ï¸</button>
  
  <div class="file-input-wrapper">
    <button style="background: #2ecc71;">
      <i class="fas fa-image"></i> æ’å…¥å›¾ç‰‡
    </button>
    <input 
      type="file" 
      id="imageInput" 
      accept="image/*" 
      onchange="handleImageUpload(event)"
    />
  </div>
  
  <button onclick="toggleDoodle()">
    <i class="fas fa-paint-brush"></i> æ¶‚é¸¦
  </button>
  
  <span style="font-size: 0.8rem; color: #666; margin-left: 10px;">
    æç¤ºï¼šCtrl+ç‚¹å‡»å›¾ç‰‡å¯åˆ é™¤
  </span>
</div>
  
  <!-- æ¶‚é¸¦åŒºåŸŸ -->
  <div id="doodle-container" style="display: none; margin-top: 15px; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
    <canvas id="diary-canvas" width="300" height="200" style="border: 1px solid #aaa; display: block; margin: 0 auto;"></canvas>
    <div style="text-align: center; margin-top: 10px;">

      <button onclick="clearDoodle()">æ¸…é™¤</button>
      <button onclick="insertDoodle()">æ’å…¥æ¶‚é¸¦</button>
      <button onclick="toggleDoodle()">å…³é—­</button>
    </div>
  </div>
  
  <div class="button-group">
    <button class="btn-prev" id="prev3">ä¸Šä¸€æ­¥</button>
    <button class="btn-next" id="next3">ä¸‹ä¸€æ­¥</button>
  </div>
</div>
        
        <!-- æ­¥éª¤4ï¼šé¢„è§ˆå’Œæäº¤ -->
        <div class="step" id="step4">
          <h2>é¢„è§ˆä½ çš„æ—¥è®°</h2>
          <div class="preview-item">
            <div class="preview-label">æ—¥æœŸï¼š</div>
            <div id="preview-date">2025å¹´10æœˆ27æ—¥</div>
          </div>
          <div class="preview-item">
            <div class="preview-label">å¤©æ°”ï¼š</div>
            <div id="preview-weather"></div>
          </div>
          <div class="preview-item">
            <div class="preview-label">å¿ƒæƒ…ï¼š</div>
            <div id="preview-mood"></div>
          </div>
          <div class="preview-item">
            <div class="preview-label">æ—¥è®°å†…å®¹ï¼š</div>
            <div id="preview-content"></div>
          </div>
          <button class="btn-submit" id="submit-diary">æäº¤æ—¥è®°</button>
        </div>
      </div>
    </div>
  
  <!-- æ—¶é—´è®°å½•é¡µé¢ -->
  <div id="time" class="page">
    <h1>æ—¶é—´è®°å½•</h1>
    <p>è¿™é‡ŒæŒ‰æ—¶é—´é¡ºåºæ˜¾ç¤ºæ‚¨ä¹‹å‰å†™è¿‡çš„æ—¥è®°</p>
    
    <div class="timeline" id="timeline">
      <!-- æ—¶é—´è½´å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>
  
  <!-- ä¸ªäººä¸­å¿ƒé¡µé¢ -->
  <div id="my" class="page">
    <h1>æˆ‘çš„</h1>
    <p>è¿™æ˜¯ä¸ªäººä¸­å¿ƒé¡µå†…å®¹...</p>
  </div>

  <!-- æ—¥è®°è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div id="diary-detail-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2>æ—¥è®°è¯¦æƒ…</h2>
      
      <div class="diary-detail">
        <div class="diary-detail-item">
          <span class="diary-detail-label">æ—¥æœŸï¼š</span>
          <span id="detail-date" class="diary-detail-content">2025å¹´10æœˆ27æ—¥</span>
        </div>
        
        <div class="diary-detail-item">
          <span class="diary-detail-label">å¤©æ°”ï¼š</span>
          <span id="detail-weather" class="diary-detail-content">æ™´æœ—</span>
          <select id="edit-weather" class="diary-edit-content">
            <option value="sunny">æ™´æœ—</option>
            <option value="cloudy">å¤šäº‘</option>
            <option value="rainy">é›¨å¤©</option>
            <option value="snowy">é›ªå¤©</option>
            <option value="windy">å¤§é£</option>
          </select>
        </div>
        
        <div class="diary-detail-item">
          <span class="diary-detail-label">å¿ƒæƒ…ï¼š</span>
          <span id="detail-mood" class="diary-detail-content">å¼€å¿ƒ</span>
          <select id="edit-mood" class="diary-edit-content">
            <option value="happy">å¼€å¿ƒ</option>
            <option value="sad">éš¾è¿‡</option>
            <option value="angry">ç”Ÿæ°”</option>
            <option value="tired">ç–²æƒ«</option>
            <option value="excited">å…´å¥‹</option>
          </select>
        </div>
        
        <div class="diary-detail-item">
          <span class="diary-detail-label">å†…å®¹ï¼š</span>
          <div id="detail-content" class="diary-detail-content">è¿™é‡Œæ˜¯æ—¥è®°å†…å®¹...</div>
          <textarea id="edit-content" class="diary-edit-content">è¿™é‡Œæ˜¯æ—¥è®°å†…å®¹...</textarea>
        </div>
      </div>
      
      <div class="diary-actions">
        <button class="edit-btn" id="edit-diary">ç¼–è¾‘</button>
        <button class="delete-btn" id="delete-diary">åˆ é™¤</button>
        <button class="save-btn" id="save-diary" style="display:none">ä¿å­˜</button>
        <button class="cancel-btn" id="cancel-edit" style="display:none">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <nav>
    <a href="#" class="nav-link active" data-page="home">
      <i class="fas fa-home"></i>
      <span>é¦–é¡µ</span>
    </a>
    <a href="#" class="nav-link" data-page="time">
      <i class="fas fa-clock"></i>
      <span>æ—¶é—´è®°å½•</span>
    </a>
    <a href="#" class="nav-link" data-page="my">
      <i class="fas fa-user"></i>
      <span>æˆ‘çš„</span>
    </a>
  </nav>

  <script>
// é¡µé¢å¯¼èˆªåŠŸèƒ½
document.querySelectorAll('.nav-link').forEach(link => {
  link.addEventListener('click', function(e) {
    e.preventDefault();
    const pageId = this.getAttribute('data-page');
    
    // æ›´æ–°å¯¼èˆªæ¿€æ´»çŠ¶æ€
    document.querySelectorAll('.nav-link').forEach(nav => {
      nav.classList.remove('active');
    });
    this.classList.add('active');
    
    // éšè—æ‰€æœ‰é¡µé¢
    document.querySelectorAll('.page').forEach(page => {
      page.classList.remove('active');
    });
    
    // æ˜¾ç¤ºé€‰ä¸­çš„é¡µé¢
    document.getElementById(pageId).classList.add('active');
    
    // å¦‚æœæ˜¯æ—¶é—´è®°å½•é¡µé¢ï¼Œæ›´æ–°æ—¶é—´è½´
    if (pageId === 'time') {
      updateTimeline();
    }
    
    // æ›´æ–°URL
    window.history.pushState({}, '', `#${pageId}`);
  });
});

// æ ¹æ®hashåˆå§‹åŒ–é¡µé¢
window.addEventListener('load', function() {
  const hash = window.location.hash.substring(1);
  if (hash) {
    const targetPage = document.getElementById(hash);
    if (targetPage) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      targetPage.classList.add('active');
      
      // æ›´æ–°å¯¼èˆªæ¿€æ´»çŠ¶æ€
      document.querySelectorAll('.nav-link').forEach(nav => {
        nav.classList.remove('active');
        if (nav.getAttribute('data-page') === hash) {
          nav.classList.add('active');
        }
      });
    }
  }
  
  // åˆå§‹åŒ–æ—¥æœŸ
  updateCurrentDate();
  
  // åˆå§‹åŒ–æ—¶é—´è½´
  updateTimeline();
});

// æ—¥è®°è®°å½•æµç¨‹åŠŸèƒ½
let currentStep = 1;
const totalSteps = 4;

// æ—¥è®°æ•°æ®
const diaryData = {
  date: new Date().toLocaleDateString('zh-CN'),
  weather: '',
  mood: '',
  content: ''
};

// åˆå§‹åŒ–è¿›åº¦æ¡
updateProgress();

// å¤©æ°”é€‰æ‹©
document.querySelectorAll('#step1 .option').forEach(option => {
  option.addEventListener('click', function() {
    document.querySelectorAll('#step1 .option').forEach(opt => {
      opt.classList.remove('selected');
    });
    this.classList.add('selected');
    diaryData.weather = this.getAttribute('data-value');
  });
});

// å¿ƒæƒ…é€‰æ‹©
document.querySelectorAll('#step2 .option').forEach(option => {
  option.addEventListener('click', function() {
    document.querySelectorAll('#step2 .option').forEach(opt => {
      opt.classList.remove('selected');
    });
    this.classList.add('selected');
    diaryData.mood = this.getAttribute('data-value');
  });
});

// ä¸‹ä¸€æ­¥æŒ‰é’®äº‹ä»¶
document.getElementById('next1').addEventListener('click', function() {
  if (diaryData.weather) {
    goToStep(2);
  } else {
    alert('è¯·é€‰æ‹©å¤©æ°”');
  }
});

document.getElementById('next2').addEventListener('click', function() {
  if (diaryData.mood) {
    goToStep(3);
  } else {
    alert('è¯·é€‰æ‹©å¿ƒæƒ…');
  }
});

// ç®€åŒ–å›¾ç‰‡æ’å…¥åŠŸèƒ½ - æ’å…¥æ—¶æ§åˆ¶å¤§å°ï¼Œç¡®è®¤ååªä¿ç•™å›¾ç‰‡
function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
    return;
  }
  
  if (file.size > 3 * 1024 * 1024) {
    alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡3MBï¼');
    return;
  }
  
  const reader = new FileReader();
  
  reader.onload = function(e) {
    const content = document.getElementById('diary-content');
    content.focus();
    
    const selection = window.getSelection();
    const range = selection.getRangeAt(0);
    
    // åˆ›å»ºä¸´æ—¶å›¾ç‰‡å®¹å™¨ï¼ˆåªåœ¨ç¼–è¾‘æ—¶æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®ï¼‰
    const tempContainer = document.createElement('div');
    tempContainer.className = 'temp-image-container';
    tempContainer.style.margin = '10px 0';
    tempContainer.style.padding = '8px';
    tempContainer.style.background = '#f5f7fa';
    tempContainer.style.borderRadius = '6px';
    tempContainer.style.border = '1px dashed #cbd5e0';
    
    // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
    const img = document.createElement('img');
    img.src = e.target.result;
    img.className = 'editable-image';
    img.style.display = 'block';
    img.style.margin = '0 auto';
    img.style.borderRadius = '4px';
    img.style.cursor = 'pointer';
    
    // å›¾ç‰‡åŠ è½½å®Œæˆåè®¾ç½®é»˜è®¤å¤§å°
    img.onload = function() {
      setImageSize(img, 'medium');
    };
    
    // åˆ›å»ºç®€å•çš„å¤§å°æ§åˆ¶æŒ‰é’®
    const sizeControls = document.createElement('div');
    sizeControls.className = 'simple-size-controls';
    sizeControls.style.marginTop = '8px';
    sizeControls.style.textAlign = 'center';
    sizeControls.style.display = 'flex';
    sizeControls.style.justifyContent = 'center';
    sizeControls.style.gap = '5px';
    sizeControls.style.flexWrap = 'wrap';
    
    // å¤§å°é€‰é¡¹
    const sizes = [
      { label: 'å°', value: 'small' },
      { label: 'ä¸­', value: 'medium' },
      { label: 'å¤§', value: 'large' }
    ];
    
    sizes.forEach(size => {
      const btn = document.createElement('button');
      btn.textContent = size.label;
      btn.className = 'simple-size-btn';
      btn.onclick = (e) => {
        e.stopPropagation();
        setImageSize(img, size.value);
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        sizeControls.querySelectorAll('.simple-size-btn').forEach(b => {
          b.classList.remove('active');
        });
        btn.classList.add('active');
      };
      if (size.value === 'medium') btn.classList.add('active');
      sizeControls.appendChild(btn);
    });
    
    // ç¡®è®¤æ’å…¥æŒ‰é’®
    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'ç¡®è®¤æ’å…¥';
    confirmBtn.className = 'confirm-insert-btn';
    confirmBtn.onclick = (e) => {
      e.stopPropagation();
      confirmImageInsertion(img, tempContainer);
    };
    sizeControls.appendChild(confirmBtn);
    
    // å–æ¶ˆæŒ‰é’®
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'å–æ¶ˆ';
    cancelBtn.className = 'cancel-insert-btn';
    cancelBtn.onclick = (e) => {
      e.stopPropagation();
      tempContainer.remove();
    };
    sizeControls.appendChild(cancelBtn);
    
    // ç»„è£…ä¸´æ—¶å®¹å™¨
    tempContainer.appendChild(img);
    tempContainer.appendChild(sizeControls);
    
    // æ’å…¥åˆ°å…‰æ ‡ä½ç½®
    range.insertNode(tempContainer);
    
    // ç§»åŠ¨å…‰æ ‡åˆ°å®¹å™¨åé¢
    range.setStartAfter(tempContainer);
    range.setEndAfter(tempContainer);
    selection.removeAllRanges();
    selection.addRange(range);
    
    event.target.value = '';
  };
  
  reader.onerror = function() {
    alert('å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
  };
  
  reader.readAsDataURL(file);
}

// è®¾ç½®å›¾ç‰‡å¤§å°
function setImageSize(img, size) {
  const sizes = {
    small: { width: '200px', height: 'auto' },
    medium: { width: '350px', height: 'auto' },
    large: { width: '500px', height: 'auto' }
  };
  
  const config = sizes[size] || sizes.medium;
  img.style.width = config.width;
  img.style.height = config.height;
  img.dataset.currentSize = size;
}

// ç¡®è®¤æ’å…¥å›¾ç‰‡ï¼ˆç§»é™¤æ§åˆ¶æŒ‰é’®ï¼Œåªä¿ç•™å›¾ç‰‡ï¼‰
function confirmImageInsertion(img, container) {
  // åˆ›å»ºæœ€ç»ˆçš„å›¾ç‰‡å…ƒç´ ï¼ˆä¸å¸¦å®¹å™¨ï¼‰
  const finalImg = document.createElement('img');
  finalImg.src = img.src;
  finalImg.style.width = img.style.width;
  finalImg.style.height = img.style.height;
  finalImg.style.margin = '10px 0';
  finalImg.style.borderRadius = '6px';
  finalImg.style.maxWidth = '100%';
  finalImg.style.cursor = 'pointer';
  
  // æ·»åŠ ç‚¹å‡»åˆ é™¤åŠŸèƒ½
  finalImg.addEventListener('click', function(e) {
    if (e.ctrlKey) { // æŒ‰ä½Ctrlé”®ç‚¹å‡»åˆ é™¤
      if (confirm('ç¡®å®šåˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
        this.remove();
      }
    }
  });
  
  // ç”¨æœ€ç»ˆå›¾ç‰‡æ›¿æ¢ä¸´æ—¶å®¹å™¨
  container.parentNode.replaceChild(finalImg, container);
  
  // åœ¨å›¾ç‰‡åæ·»åŠ æ¢è¡Œï¼Œæ–¹ä¾¿ç»§ç»­è¾“å…¥
  const br = document.createElement('br');
  finalImg.parentNode.insertBefore(br, finalImg.nextSibling);
  
  // èšç„¦åˆ°å†…å®¹åŒºåŸŸ
  const content = document.getElementById('diary-content');
  content.focus();
  
  // ç§»åŠ¨å…‰æ ‡åˆ°å›¾ç‰‡åé¢
  const selection = window.getSelection();
  const range = document.createRange();
  range.setStartAfter(br);
  range.setEndAfter(br);
  selection.removeAllRanges();
  selection.addRange(range);
}

// ç‚¹å‡»å›¾ç‰‡é¢„è§ˆå¤§å›¾
function initImagePreview() {
  document.addEventListener('click', function(e) {
    if (e.target.tagName === 'IMG' && 
        !e.target.classList.contains('editable-image') && 
        !e.ctrlKey) {
      
      const img = e.target;
      
      // åˆ›å»ºé¢„è§ˆæ¨¡æ€æ¡†
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100%';
      modal.style.height = '100%';
      modal.style.backgroundColor = 'rgba(0,0,0,0.9)';
      modal.style.display = 'flex';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'center';
      modal.style.zIndex = '10000';
      modal.style.cursor = 'zoom-out';
      
      const previewImg = document.createElement('img');
      previewImg.src = img.src;
      previewImg.style.maxWidth = '90%';
      previewImg.style.maxHeight = '90%';
      previewImg.style.objectFit = 'contain';
      previewImg.style.borderRadius = '8px';
      
      modal.appendChild(previewImg);
      document.body.appendChild(modal);
      
      // ç‚¹å‡»å…³é—­
      modal.addEventListener('click', function() {
        document.body.removeChild(modal);
      });
      
      // ESCé”®å…³é—­
      const closeModal = function(e) {
        if (e.key === 'Escape') {
          document.body.removeChild(modal);
          document.removeEventListener('keydown', closeModal);
        }
      };
      document.addEventListener('keydown', closeModal);
    }
  });
}

// åˆå§‹åŒ–å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
  setupImagePreview();
});

document.getElementById('next3').addEventListener('click', function() {
  const content = document.getElementById('diary-content');
  const hasText = content.textContent.trim().length > 0;
  const hasImages = content.querySelectorAll('img').length > 0;
  
  if (hasText || hasImages) {
    diaryData.content = content.innerHTML;
    updatePreview();
    goToStep(4);
  } else {
    alert('è¯·å¡«å†™æ—¥è®°å†…å®¹æˆ–æ’å…¥å›¾ç‰‡/æ¶‚é¸¦');
  }
});

// ä¸Šä¸€æ­¥æŒ‰é’®äº‹ä»¶
document.getElementById('prev2').addEventListener('click', function() {
  goToStep(1);
});

document.getElementById('prev3').addEventListener('click', function() {
  goToStep(2);
});

// æäº¤æ—¥è®°
document.getElementById('submit-diary').addEventListener('click', function() {
  // ä¿å­˜æ—¥è®°åˆ°æœ¬åœ°å­˜å‚¨
  let diaries = JSON.parse(localStorage.getItem('diaries')) || [];
  diaries.push({
    ...diaryData,
    id: Date.now() // æ·»åŠ å”¯ä¸€ID
  });
  localStorage.setItem('diaries', JSON.stringify(diaries));

  
  // é‡ç½®è¡¨å•
  resetDiaryForm();
  
  // éšè—æ—¥è®°è®°å½•æµç¨‹æ‚¬æµ®æ¡†
  document.getElementById('diary-overlay').classList.remove('active');
  
  alert('æ—¥è®°æäº¤æˆåŠŸï¼');
});

// è·³è½¬åˆ°æŒ‡å®šæ­¥éª¤
function goToStep(step) {
  document.querySelector(`.step.active`).classList.remove('active');
  document.querySelector(`#step${step}`).classList.add('active');
  currentStep = step;
  updateProgress();
}

// æ›´æ–°è¿›åº¦æ¡
function updateProgress() {
  const progress = (currentStep / totalSteps) * 100;
  document.getElementById('progress').style.width = `${progress}%`;
}

// æ›´æ–°å½“å‰æ—¥æœŸæ˜¾ç¤º
function updateCurrentDate() {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;
  const day = now.getDate();

  const daydata = `${day}æ—¥`;
  const otherdata = `${year}å¹´${month}æœˆ`;
  const formattedDate = `${year}å¹´${month}æœˆ${day}æ—¥`;

  document.getElementById('daytime').textContent = daydata;
  document.getElementById('othertime').textContent = otherdata;
  diaryData.date = formattedDate;
}

// æ›´æ–°é¢„è§ˆå†…å®¹
function updatePreview() {
  document.getElementById('preview-date').textContent = diaryData.date;
  
  // å¤©æ°”é¢„è§ˆ
  const weatherOptions = {
    sunny: 'æ™´æœ— â˜€ï¸',
    cloudy: 'å¤šäº‘ â˜ï¸',
    rainy: 'é›¨å¤© ğŸŒ§ï¸',
    snowy: 'é›ªå¤© â„ï¸',
    windy: 'å¤§é£ ğŸ’¨'
  };
  document.getElementById('preview-weather').textContent = weatherOptions[diaryData.weather];
  
  // å¿ƒæƒ…é¢„è§ˆ
  const moodOptions = {
    happy: 'å¼€å¿ƒ ğŸ˜Š',
    sad: 'éš¾è¿‡ ğŸ˜¢',
    angry: 'ç”Ÿæ°” ğŸ˜ ',
    tired: 'ç–²æƒ« ğŸ˜ª',
    excited: 'å…´å¥‹ ğŸ¤©'
  };
  document.getElementById('preview-mood').textContent = moodOptions[diaryData.mood];
  
  // æ—¥è®°å†…å®¹é¢„è§ˆ
  document.getElementById('preview-content').innerHTML = diaryData.content;
}

// é‡ç½®æ—¥è®°è¡¨å•
function resetDiaryForm() {
  // é‡ç½®æ•°æ®
  diaryData.weather = '';
  diaryData.mood = '';
  diaryData.content = '';
  
  // é‡ç½®UI
  document.querySelectorAll('.option').forEach(opt => {
    opt.classList.remove('selected');
  });
  document.getElementById('diary-content').innerHTML = '';
  
  // å›åˆ°ç¬¬ä¸€æ­¥
  goToStep(1);
}

// æ›´æ–°é¦–é¡µæ˜¾ç¤º

// æ’å…¥å›¾ç‰‡åŠŸèƒ½


// è¡¨æƒ…æ’å…¥åŠŸèƒ½
function insertEmoji(emoji) {
  const content = document.getElementById('diary-content');
  const selection = window.getSelection();
  
  if (selection.rangeCount > 0) {
    const range = selection.getRangeAt(0);
    range.deleteContents();
    const node = document.createTextNode(emoji);
    range.insertNode(node);
    range.setStartAfter(node);
    range.setEndAfter(node);
    selection.removeAllRanges();
    selection.addRange(range);
  } else {
    // å¦‚æœæ²¡æœ‰é€‰æ‹©ï¼Œåˆ™åœ¨æœ«å°¾æ’å…¥
    content.innerHTML += emoji;
  }
  
  content.focus();
}

// æ¶‚é¸¦åŠŸèƒ½
let drawing = false;
let currentColor = 'black';
let brushSize = 5;
const canvas = document.getElementById('diary-canvas');
const ctx = canvas.getContext('2d');

// åˆå§‹åŒ–æ¶‚é¸¦åŠŸèƒ½
function initDoodle() {
  canvas.addEventListener('mousedown', startDrawing);
  canvas.addEventListener('mouseup', stopDrawing);
  canvas.addEventListener('mouseout', stopDrawing);
  canvas.addEventListener('mousemove', draw);
  
  // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
  canvas.addEventListener('touchstart', handleTouchStart);
  canvas.addEventListener('touchend', stopDrawing);
  canvas.addEventListener('touchmove', handleTouchMove);
}

// åˆå§‹åŒ–æ¶‚é¸¦
initDoodle();

function startDrawing(e) {
  drawing = true;
  draw(e);
}

function stopDrawing() {
  drawing = false;
  ctx.beginPath();
}

function draw(e) {
  if (!drawing) return;
  
  const rect = canvas.getBoundingClientRect();
  
  let x, y;
  if (e.type.includes('touch')) {
    x = e.touches[0].clientX - rect.left;
    y = e.touches[0].clientY - rect.top;
  } else {
    x = e.offsetX;
    y = e.offsetY;
  }
  
  ctx.lineWidth = brushSize;
  ctx.lineCap = "round";
  ctx.strokeStyle = currentColor;
  
  ctx.lineTo(x, y);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(x, y);
}

function handleTouchStart(e) {
  e.preventDefault();
  const touch = e.touches[0];
  const mouseEvent = new MouseEvent("mousedown", {
    clientX: touch.clientX,
    clientY: touch.clientY
  });
  canvas.dispatchEvent(mouseEvent);
}

function handleTouchMove(e) {
  e.preventDefault();
  const touch = e.touches[0];
  const mouseEvent = new MouseEvent("mousemove", {
    clientX: touch.clientX,
    clientY: touch.clientY
  });
  canvas.dispatchEvent(mouseEvent);
}

// æ˜¾ç¤º/éšè—æ¶‚é¸¦åŒºåŸŸ
function toggleDoodle() {
  const container = document.getElementById('doodle-container');
  container.style.display = container.style.display === 'none' ? 'block' : 'none';
}

// æ”¹å˜æ¶‚é¸¦é¢œè‰²
function changeDoodleColor(color) {
  currentColor = color;
}

// æ”¹å˜ç¬”åˆ·å¤§å°
function changeBrushSize(size) {
  brushSize = size;
}

// æ¸…é™¤æ¶‚é¸¦
function clearDoodle() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

// æ’å…¥æ¶‚é¸¦åˆ°æ—¥è®°
function insertDoodle() {
  const content = document.getElementById('diary-content');
  const dataURL = canvas.toDataURL();
  
  // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
  const img = document.createElement('img');
  img.src = dataURL;
  img.style.maxWidth = '100%';
  img.style.margin = '10px 0';
  img.style.borderRadius = '5px';
  
  // æ’å…¥åˆ°å†…å®¹åŒºåŸŸ
  content.appendChild(img);
  content.appendChild(document.createElement('br'));
  
  // æ¸…é™¤ç”»å¸ƒå¹¶éšè—æ¶‚é¸¦åŒºåŸŸ
  clearDoodle();
  toggleDoodle();
  
  // èšç„¦åˆ°å†…å®¹åŒºåŸŸ
  content.focus();
}

// å¼€å§‹è®°å½•æ—¥è®° - æ˜¾ç¤ºæ‚¬æµ®æ¡†
document.getElementById('record-today').addEventListener('click', function() {
  // æ˜¾ç¤ºæ—¥è®°è®°å½•æµç¨‹æ‚¬æµ®æ¡†
  document.getElementById('diary-overlay').classList.add('active');
  
  // é‡ç½®è¡¨å•
  resetDiaryForm();
  
  // æ›´æ–°æ—¥æœŸ
  diaryData.date = new Date().toLocaleDateString('zh-CN');
});

// ç‚¹å‡»æ‚¬æµ®æ¡†å¤–éƒ¨å…³é—­
document.getElementById('diary-overlay').addEventListener('click', function(e) {
  if (e.target === this) {
    this.classList.remove('active');
  }
});

// æ›´æ–°æ—¶é—´è½´
function updateTimeline() {
  const timeline = document.getElementById('timeline');
  const diaries = JSON.parse(localStorage.getItem('diaries')) || [];
  
  // æ¸…ç©ºæ—¶é—´è½´
  timeline.innerHTML = '';
  
  if (diaries.length === 0) {
    timeline.innerHTML = '<p style="text-align:center; color:#666; margin:40px 0;">è¿˜æ²¡æœ‰æ—¥è®°è®°å½•ï¼Œå¿«å»å†™ä¸€ç¯‡å§ï¼</p>';
    return;
  }
  
  // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
  diaries.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  // ç”Ÿæˆæ—¶é—´è½´é¡¹ç›®
  diaries.forEach((diary, index) => {
    const timelineItem = document.createElement('div');
    timelineItem.className = `timeline-item ${index % 2 === 0 ? 'left' : 'right'}`;
    
    // å¤©æ°”å’Œå¿ƒæƒ…çš„æ˜¾ç¤ºæ–‡æœ¬
    const weatherOptions = {
      sunny: 'æ™´æœ— â˜€ï¸',
      cloudy: 'å¤šäº‘ â˜ï¸',
      rainy: 'é›¨å¤© ğŸŒ§ï¸',
      snowy: 'é›ªå¤© â„ï¸',
      windy: 'å¤§é£ ğŸ’¨'
    };
    
    const moodOptions = {
      happy: 'å¼€å¿ƒ ğŸ˜Š',
      sad: 'éš¾è¿‡ ğŸ˜¢',
      angry: 'ç”Ÿæ°” ğŸ˜ ',
      tired: 'ç–²æƒ« ğŸ˜ª',
      excited: 'å…´å¥‹ ğŸ¤©'
    };
    
    // åˆ›å»ºé¢„è§ˆæ–‡æœ¬ï¼ˆå»é™¤HTMLæ ‡ç­¾ï¼‰
    let previewText = diary.content.replace(/<[^>]*>/g, '');
    previewText = previewText.substring(0, 80) + (previewText.length > 80 ? '...' : '');
    
    timelineItem.innerHTML = `
      <div class="timeline-content" data-id="${diary.id}">
        <div class="timeline-date">${diary.date}</div>
        <div class="timeline-weather">${weatherOptions[diary.weather] || diary.weather}</div>
        <div class="timeline-mood">${moodOptions[diary.mood] || diary.mood}</div>
        <div class="timeline-preview">${previewText}</div>
      </div>
    `;
    
    timeline.appendChild(timelineItem);
  });
  
  // æ·»åŠ ç‚¹å‡»äº‹ä»¶
  document.querySelectorAll('.timeline-content').forEach(item => {
    item.addEventListener('click', function() {
      const diaryId = parseInt(this.getAttribute('data-id'));
      showDiaryDetail(diaryId);
    });
  });
}

// æ˜¾ç¤ºæ—¥è®°è¯¦æƒ…
function showDiaryDetail(diaryId) {
  const diaries = JSON.parse(localStorage.getItem('diaries')) || [];
  const diary = diaries.find(d => d.id === diaryId);
  
  if (!diary) {
    alert('æ—¥è®°ä¸å­˜åœ¨ï¼');
    return;
  }
  
  // å¤©æ°”å’Œå¿ƒæƒ…çš„æ˜¾ç¤ºæ–‡æœ¬
  const weatherOptions = {
    sunny: 'æ™´æœ— â˜€ï¸',
    cloudy: 'å¤šäº‘ â˜ï¸',
    rainy: 'é›¨å¤© ğŸŒ§ï¸',
    snowy: 'é›ªå¤© â„ï¸',
    windy: 'å¤§é£ ğŸ’¨'
  };
  
  const moodOptions = {
    happy: 'å¼€å¿ƒ ğŸ˜Š',
    sad: 'éš¾è¿‡ ğŸ˜¢',
    angry: 'ç”Ÿæ°” ğŸ˜ ',
    tired: 'ç–²æƒ« ğŸ˜ª',
    excited: 'å…´å¥‹ ğŸ¤©'
  };
  
  // å¡«å……è¯¦æƒ…
  document.getElementById('detail-date').textContent = diary.date;
  document.getElementById('detail-weather').textContent = weatherOptions[diary.weather] || diary.weather;
  document.getElementById('detail-mood').textContent = moodOptions[diary.mood] || diary.mood;
  document.getElementById('detail-content').innerHTML = diary.content;
  
  // è®¾ç½®ç¼–è¾‘è¡¨å•çš„å€¼
  document.getElementById('edit-weather').value = diary.weather;
  document.getElementById('edit-mood').value = diary.mood;
  document.getElementById('edit-content').value = diary.content.replace(/<[^>]*>/g, '');
  
  // å­˜å‚¨å½“å‰ç¼–è¾‘çš„æ—¥è®°ID
  document.getElementById('diary-detail-modal').setAttribute('data-current-id', diaryId);
  
  // é€€å‡ºç¼–è¾‘æ¨¡å¼
  exitEditMode();
  
  // æ˜¾ç¤ºæ¨¡æ€æ¡†
  document.getElementById('diary-detail-modal').style.display = 'block';
}

// è¿›å…¥ç¼–è¾‘æ¨¡å¼
function enterEditMode() {
  const modal = document.getElementById('diary-detail-modal');
  modal.classList.add('edit-mode');
  
  document.getElementById('edit-diary').style.display = 'none';
  document.getElementById('delete-diary').style.display = 'none';
  document.getElementById('save-diary').style.display = 'inline-block';
  document.getElementById('cancel-edit').style.display = 'inline-block';
}

// é€€å‡ºç¼–è¾‘æ¨¡å¼
function exitEditMode() {
  const modal = document.getElementById('diary-detail-modal');
  modal.classList.remove('edit-mode');
  
  document.getElementById('edit-diary').style.display = 'inline-block';
  document.getElementById('delete-diary').style.display = 'inline-block';
  document.getElementById('save-diary').style.display = 'none';
  document.getElementById('cancel-edit').style.display = 'none';
}

// ä¿å­˜æ—¥è®°ä¿®æ”¹
function saveDiaryEdit() {
  const diaryId = parseInt(document.getElementById('diary-detail-modal').getAttribute('data-current-id'));
  const diaries = JSON.parse(localStorage.getItem('diaries')) || [];
  const diaryIndex = diaries.findIndex(d => d.id === diaryId);
  
  if (diaryIndex === -1) {
    alert('æ—¥è®°ä¸å­˜åœ¨ï¼');
    return;
  }
  
  // æ›´æ–°æ—¥è®°å†…å®¹
  diaries[diaryIndex].weather = document.getElementById('edit-weather').value;
  diaries[diaryIndex].mood = document.getElementById('edit-mood').value;
  diaries[diaryIndex].content = document.getElementById('edit-content').value;
  
  // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
  localStorage.setItem('diaries', JSON.stringify(diaries));
  
  // æ›´æ–°æ—¶é—´è½´
  updateTimeline();
  
  // é€€å‡ºç¼–è¾‘æ¨¡å¼
  exitEditMode();
  
  // åˆ·æ–°è¯¦æƒ…æ˜¾ç¤º
  showDiaryDetail(diaryId);
  
  alert('æ—¥è®°ä¿®æ”¹æˆåŠŸï¼');
}

// åˆ é™¤æ—¥è®°
function deleteDiary() {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
    return;
  }
  
  const diaryId = parseInt(document.getElementById('diary-detail-modal').getAttribute('data-current-id'));
  let diaries = JSON.parse(localStorage.getItem('diaries')) || [];
  
  // è¿‡æ»¤æ‰è¦åˆ é™¤çš„æ—¥è®°
  diaries = diaries.filter(d => d.id !== diaryId);
  
  // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
  localStorage.setItem('diaries', JSON.stringify(diaries));
  
  // æ›´æ–°æ—¶é—´è½´
  updateTimeline();
  
  // å…³é—­æ¨¡æ€æ¡†
  document.getElementById('diary-detail-modal').style.display = 'none';
  
  alert('æ—¥è®°åˆ é™¤æˆåŠŸï¼');
}

// æ¨¡æ€æ¡†äº‹ä»¶ç»‘å®š
document.querySelector('.close-btn').addEventListener('click', function() {
  document.getElementById('diary-detail-modal').style.display = 'none';
});

document.getElementById('edit-diary').addEventListener('click', enterEditMode);
document.getElementById('save-diary').addEventListener('click', saveDiaryEdit);
document.getElementById('cancel-edit').addEventListener('click', exitEditMode);
document.getElementById('delete-diary').addEventListener('click', deleteDiary);

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
window.addEventListener('click', function(event) {
  const modal = document.getElementById('diary-detail-modal');
  if (event.target === modal) {
    modal.style.display = 'none';
  }
});

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„æ—¥è®°
window.addEventListener('load', function() {
  updateCurrentDate();
  const diaries = JSON.parse(localStorage.getItem('diaries')) || [];
  if (diaries.length > 0) {
  }
  // åˆå§‹åŒ–æ—¶é—´è½´
  updateTimeline();
});
  </script>
</body>
</html>
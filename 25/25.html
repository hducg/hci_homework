<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æˆ‘çš„å¤šåª’ä½“æ—¥è®°</title>
  <style>
    /* å…¨å±€æ ·å¼ï¼šç»Ÿä¸€é—´è·ä¸å­—ä½“ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Microsoft YaHei", sans-serif;
      background-color: #f0f5f9;
      color: #333;
      line-height: 1.5;
      padding: 20px 0;
    }

    /* æ ‡é¢˜æ ·å¼ï¼šå±…ä¸­ä¸”å¢åŠ åº•éƒ¨é—´è· */
    h1 {
      text-align: center;
      color: #2c3e50;
      padding: 15px 0;
      margin: 0 auto 30px;
      border-bottom: 2px solid #3498db;
      width: 90%;
      max-width: 800px;
    }

    /* å®¹å™¨æ ·å¼ï¼šå›ºå®šå®½åº¦+å±…ä¸­ï¼Œå¢åŠ å†…è¾¹è· */
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* ç™»å½•é¢æ¿ï¼šå±…ä¸­+ä¼˜åŒ–å°ºå¯¸ä¸é—´è· */
    #login-panel {
      max-width: 450px;
      margin: 30px auto;
      padding: 30px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    /* æ—¥è®°é¢æ¿ï¼šé»˜è®¤éšè—ï¼Œç»Ÿä¸€å†…éƒ¨é—´è· */
    #diary-panel {
      display: none;
    }

    /* ç”¨æˆ·ä¿¡æ¯æ ï¼šä¼˜åŒ–å¯¹é½ä¸é—´è· */
    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding: 10px 15px;
      background-color: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    .user-info label {
      font-weight: 600;
      color: #2c3e50;
    }

    /* è¡¨å•ç»„ï¼šç»Ÿä¸€é—´è·ä¸è§†è§‰é£æ ¼ */
    .form-group {
      background-color: #fff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    .form-group:last-of-type {
      margin-bottom: 30px;
    }

    /* æ ‡ç­¾æ ·å¼ï¼šç»Ÿä¸€é—´è·ä¸é¢œè‰² */
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: #2c3e50;
    }

    /* è¾“å…¥æ¡†/ä¸‹æ‹‰æ¡†ï¼šç»Ÿä¸€å°ºå¯¸ä¸è¾¹æ¡† */
    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    /* å¯Œæ–‡æœ¬åŒºåŸŸï¼šä¼˜åŒ–é«˜åº¦ä¸å†…è¾¹è· */
    #diary-content {
      min-height: 220px;
      border: 1px solid #ddd;
      padding: 15px;
      background-color: #fff;
      border-radius: 6px;
      font-size: 14px;
      overflow: auto;
      white-space: pre-wrap;
    }

    /* å·¥å…·æ ï¼šä¼˜åŒ–æŒ‰é’®é—´è· */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .toolbar button {
      padding: 8px 15px;
      background-color: #f1f5f9;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .toolbar button:hover {
      background-color: #e2e8f0;
    }
    .toolbar input[type="file"] {
      width: auto;
      padding: 8px;
    }

    /* æŒ‰é’®é€šç”¨æ ·å¼ï¼šç»Ÿä¸€å°ºå¯¸ä¸é¢œè‰² */
    .action-btn {
      padding: 10px 20px;
      background-color: #3498db;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    .action-btn:hover {
      background-color: #024978;
    }
    .logout-btn {
      background-color: #f44336;
    }
    .logout-btn:hover {
      background-color: #d32f2f;
    }

    /* åˆ é™¤æŒ‰é’®ï¼šä¼˜åŒ–å°ºå¯¸ä¸ä½ç½® */
    .delete-btn {
      background-color: #e74c3c;
      padding: 6px 12px;
      margin-left: 10px;
    }
    .delete-btn:hover {
      background-color: #c0392b;
    }

    /* æ—¥è®°åˆ—è¡¨ï¼šä¼˜åŒ–é—´è·ä¸è§†è§‰å±‚æ¬¡ */
    .diary-list {
      margin-top: 30px;
    }
    .diary-list h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }
    .diary-item {
      background-color: #fff;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .diary-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* æ—¥è®°å¤´éƒ¨ï¼šä¼˜åŒ–å¸ƒå±€ä¸æ¢è¡Œ */
    .entry-header {
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .diary-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      font-size: 14px;
    }

    /* æç¤ºæ¶ˆæ¯ï¼šä¼˜åŒ–ä½ç½®ä¸æ ·å¼ */
    .message {
      padding: 12px 15px;
      border-radius: 6px;
      margin: 0 0 20px;
      color: white;
      text-align: center;
      display: none;
    }
    .success {
      background-color: #2ecc71;
    }
    .error {
      background-color: #e74c3c;
    }

    /* æ¶‚é¸¦åŒºåŸŸï¼šä¼˜åŒ–å¯¹é½ä¸é—´è· */
    #canvas {
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 15px;
    }

    /* ç™»å½•æç¤ºï¼šä¼˜åŒ–ä½ç½®ä¸é¢œè‰² */
    #login-tip {
      color: red;
      margin-top: 15px;
      text-align: center;
      font-size: 14px;
    }

    /* å›¾ç‰‡/éŸ³é¢‘é¢„è§ˆï¼šç»Ÿä¸€å°ºå¯¸ä¸é—´è· */
    .preview-img {
      max-width: 100%;
      border-radius: 6px;
      margin: 10px 0;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .preview-audio {
      width: 100%;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <!-- ç™»å½•é¢æ¿ -->
  <div id="login-panel">
    <h1>æ—¥è®°ç™»å½•</h1>
    <div class="form-group">
      <label>ç”¨æˆ·å:</label>
      <input type="text" id="login-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
    </div>
    <div class="form-group">
      <label>å¯†ç :</label>
      <input type="password" id="login-password" placeholder="è¯·è¾“å…¥å¯†ç ">
    </div>
    <div style="display: flex; gap: 10px; justify-content: center;">
      <button class="action-btn" onclick="userRegister()">æ³¨å†Œ</button>
      <button class="action-btn" onclick="userLogin()">ç™»å½•</button>
    </div>
    <p id="login-tip"></p>
  </div>

  <!-- æ—¥è®°é¢æ¿ -->
  <div id="diary-panel" class="container">
    <h1>æˆ‘çš„å¤šåª’ä½“æ—¥è®°</h1>
    <div class="user-info">
      <div>
        <label>å½“å‰ç”¨æˆ·: <span id="current-username"></span></label>
      </div>
      <button class="action-btn logout-btn" onclick="userLogout()">é€€å‡ºç™»å½•</button>
    </div>

    <!-- æ¶ˆæ¯æç¤ºåŒºåŸŸ -->
    <div id="message" class="message"></div>

    <div class="form-group">
      <label>æ—¶é—´:</label>
      <input type="datetime-local" id="time">
    </div>

    <div class="form-group">
      <label>å¤©æ°”:</label>
      <select id="weather">
        <option>â˜€ï¸ æ™´</option>
        <option>â›… å¤šäº‘</option>
        <option>ğŸŒ§ï¸ é›¨</option>
        <option>ğŸŒ¨ï¸ é›ª</option>
      </select>
    </div>

    <div class="form-group">
      <label>å¿ƒæƒ…:</label>
      <select id="mood">
        <option>ğŸ˜Š å¼€å¿ƒ</option>
        <option>ğŸ˜” éš¾è¿‡</option>
        <option>ğŸ˜  ç”Ÿæ°”</option>
        <option>ğŸ˜Œ å¹³é™</option>
      </select>
    </div>

    <div class="form-group">
      <label>åœ°ç‚¹:</label>
      <input type="text" id="location" placeholder="è¯·è¾“å…¥åœ°ç‚¹">
    </div>

    <div class="form-group">
      <label>äº‹ä»¶ä¸æ„Ÿæƒ³:</label>
      <div id="diary-content" contenteditable="true"></div>
    </div>

    <div class="form-group toolbar">
        <label>æ’å…¥ï¼š</label>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
          <button onclick="insertEmoji('ğŸ˜Š')">ğŸ˜Š</button>
          <button onclick="insertEmoji('ğŸ˜¢')">ğŸ˜¢</button>
          <button onclick="insertEmoji('â¤ï¸')">â¤ï¸</button>
        </div>
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
          <span>é€‰æ‹©å›¾ç‰‡ï¼š</span>
          <input type="file" id="imageInput" accept="image/jpeg,image/png,image/gif" onchange="insertImage()" title="é€‰æ‹©å›¾ç‰‡">
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <span>é€‰æ‹©éŸ³é¢‘ï¼š</span>
          <input type="file" id="audioInput" accept="audio/mpeg,audio/wav,audio/mp3" onchange="insertAudio()" title="é€‰æ‹©éŸ³é¢‘">
        </div>
      </div>
      
      
      

    <div class="form-group">
      <label>æ¶‚é¸¦ï¼ˆç‚¹å‡»åä¿å­˜æ’å…¥ï¼‰:</label><br>
      <canvas id="canvas" width="300" height="200"></canvas><br>
      <button class="action-btn" style="padding: 8px 15px;" onclick="insertDoodle()">æ’å…¥æ¶‚é¸¦</button>
    </div>

    <div style="display: flex; gap: 15px; justify-content: center;">
      <button class="action-btn" onclick="saveDiary()">ä¿å­˜æ—¥è®°</button>
      <button class="action-btn" onclick="showDiaryList()">æŸ¥çœ‹æˆ‘çš„æ—¥è®°</button>
    </div>

    <div class="diary-list" id="diary-list"></div>
  </div>

  <script>
    // ç”¨æˆ·ç™»å½•æ³¨å†Œç›¸å…³é€»è¾‘
    window.onload = () => {
      const now = new Date();
      const local = now.toISOString().slice(0, 16);
      document.getElementById("time").value = local;

      const loginUser = localStorage.getItem('diary_login_user');
      if (loginUser) {
        showDiaryPanel(loginUser);
      }
    };

    function userRegister() {
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;
      const tipEl = document.getElementById('login-tip');

      if (!username || !password) {
        tipEl.textContent = 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º';
        return;
      }

      const allUsers = JSON.parse(localStorage.getItem('diary_all_users') || '{}');
      if (allUsers[username]) {
        tipEl.textContent = 'è¯¥ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·æ›´æ¢';
        return;
      }

      allUsers[username] = password;
      localStorage.setItem('diary_all_users', JSON.stringify(allUsers));
      tipEl.textContent = 'æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•';
      tipEl.style.color = 'green';
    }

    function userLogin() {
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;
      const tipEl = document.getElementById('login-tip');
      const allUsers = JSON.parse(localStorage.getItem('diary_all_users') || '{}');

      if (!allUsers[username] || allUsers[username] !== password) {
        tipEl.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
        return;
      }

      localStorage.setItem('diary_login_user', username);
      showDiaryPanel(username);
    }

    function userLogout() {
      localStorage.removeItem('diary_login_user');
      document.getElementById('login-panel').style.display = 'block';
      document.getElementById('diary-panel').style.display = 'none';
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
      document.getElementById('login-tip').textContent = '';
    }

    function showDiaryPanel(username) {
      document.getElementById('login-panel').style.display = 'none';
      document.getElementById('diary-panel').style.display = 'block';
      document.getElementById('current-username').textContent = username;
    }

    // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
    function showMessage(text, isSuccess = true) {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text;
      messageEl.className = 'message ' + (isSuccess ? 'success' : 'error');
      messageEl.style.display = 'block';
      
      setTimeout(() => {
        messageEl.style.display = 'none';
      }, 3000);
    }

    // æ—¥è®°ä¿å­˜ä¸æŸ¥çœ‹ç›¸å…³é€»è¾‘
    function saveDiary() {
      const currentUser = localStorage.getItem('diary_login_user');
      if (!currentUser) return;

      const diaryData = {
        id: Date.now(),
        time: document.getElementById('time').value,
        weather: document.getElementById('weather').value,
        mood: document.getElementById('mood').value,
        location: document.getElementById('location').value,
        content: document.getElementById('diary-content').innerHTML,
        createTime: new Date().toLocaleString()
      };

      const userDiaries = JSON.parse(localStorage.getItem(`diary_${currentUser}`) || '[]');
      userDiaries.push(diaryData);
      localStorage.setItem(`diary_${currentUser}`, JSON.stringify(userDiaries));

      showMessage('æ—¥è®°ä¿å­˜æˆåŠŸï¼');
      document.getElementById('location').value = '';
      document.getElementById('diary-content').innerHTML = '';
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function showDiaryList() {
      const currentUser = localStorage.getItem('diary_login_user');
      if (!currentUser) return;

      const userDiaries = JSON.parse(localStorage.getItem(`diary_${currentUser}`) || '[]');
      const listEl = document.getElementById('diary-list');

      listEl.innerHTML = '<h3>æˆ‘çš„æ—¥è®°åˆ—è¡¨</h3>';
      if (userDiaries.length === 0) {
        listEl.innerHTML += '<p style="text-align: center; padding: 20px; color: #666;">æš‚æ— ä¿å­˜çš„æ—¥è®°</p>';
        return;
      }

      userDiaries.sort((a, b) => b.id - a.id).forEach(diary => {
        const diaryEl = document.createElement('div');
        diaryEl.className = 'diary-item';
        diaryEl.setAttribute('data-id', diary.id);
        
        // ä¿®å¤æ—¶é—´æ ¼å¼ï¼ˆæ›¿æ¢Tä¸ºç©ºæ ¼ï¼‰å’Œåœ°ç‚¹æ˜¾ç¤ºä½ç½®
        const formattedTime = diary.time.replace('T', ' ');
        let locationHtml = diary.location ? `<span>${diary.location}</span>` : '';
        
        diaryEl.innerHTML = `
          <div class="entry-header">
            <div class="diary-meta">
              <strong>è®°å½•æ—¶é—´ï¼š</strong>${formattedTime}
              ${locationHtml}
              <span>${diary.weather}</span>
              <span>${diary.mood}</span>
            </div>
            <button class="action-btn delete-btn" onclick="deleteDiary(${diary.id})">åˆ é™¤</button>
          </div>
          <div style="padding-top: 10px;">
            ${diary.content}
          </div>
        `;
        listEl.appendChild(diaryEl);
      });
    }

    // åˆ é™¤æ—¥è®°åŠŸèƒ½
    function deleteDiary(diaryId) {
      const currentUser = localStorage.getItem('diary_login_user');
      if (!currentUser) {
        showMessage('è¯·å…ˆç™»å½•', false);
        return;
      }

      const diaryEl = document.querySelector(`.diary-item[data-id="${diaryId}"]`);
      if (!diaryEl) {
        showMessage('æœªæ‰¾åˆ°è¯¥æ—¥è®°', false);
        return;
      }

      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        return;
      }

      try {
        let userDiaries = JSON.parse(localStorage.getItem(`diary_${currentUser}`) || '[]');
        const initialLength = userDiaries.length;
        
        userDiaries = userDiaries.filter(diary => diary.id !== diaryId);
        
        if (userDiaries.length === initialLength) {
          showMessage('åˆ é™¤å¤±è´¥ï¼Œæœªæ‰¾åˆ°è¯¥æ—¥è®°', false);
          return;
        }
        
        localStorage.setItem(`diary_${currentUser}`, JSON.stringify(userDiaries));
        
        diaryEl.style.transform = 'translateX(20px)';
        diaryEl.style.opacity = '0';
        diaryEl.style.height = diaryEl.offsetHeight + 'px';
        diaryEl.style.overflow = 'hidden';
        diaryEl.style.transition = 'all 0.3s ease-out';
        
        setTimeout(() => {
          diaryEl.remove();
          if (userDiaries.length === 0) {
            document.getElementById('diary-list').innerHTML += '<p style="text-align: center; padding: 20px; color: #666;">æš‚æ— ä¿å­˜çš„æ—¥è®°</p>';
          }
          showMessage('æ—¥è®°å·²æˆåŠŸåˆ é™¤');
        }, 300);
        
      } catch (error) {
        console.error('åˆ é™¤æ—¥è®°å‡ºé”™:', error);
        showMessage('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', false);
      }
    }

    // å¤šåª’ä½“åŠŸèƒ½ï¼šä¿®å¤æ–‡ä»¶ç±»å‹æŠ¥é”™
    function insertEmoji(emoji) {
      const content = document.getElementById("diary-content");
      content.innerHTML += emoji + ' ';
      content.focus();
    }

    function insertImage() {
      const input = document.getElementById("imageInput");
      const file = input.files[0];
      if (!file) return;

      // éªŒè¯æ–‡ä»¶ç±»å‹ï¼Œé¿å…æŠ¥é”™
      const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
      if (!validTypes.includes(file.type)) {
        showMessage('ä¸æ”¯æŒè¯¥å›¾ç‰‡æ ¼å¼ï¼Œè¯·é€‰æ‹©JPG/PNG/GIF', false);
        input.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const content = document.getElementById("diary-content");
        content.innerHTML += `<br><img src="${e.target.result}" class="preview-img"><br>`;
      };
      reader.readAsDataURL(file);
      input.value = '';
    }

    function insertAudio() {
      const input = document.getElementById("audioInput");
      const file = input.files[0];
      if (!file) return;

      // éªŒè¯æ–‡ä»¶ç±»å‹ï¼Œé¿å…æŠ¥é”™
      const validTypes = ['audio/mpeg', 'audio/wav', 'audio/mp3'];
      if (!validTypes.includes(file.type)) {
        showMessage('ä¸æ”¯æŒè¯¥éŸ³é¢‘æ ¼å¼ï¼Œè¯·é€‰æ‹©MP3/WAV', false);
        input.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const content = document.getElementById("diary-content");
        content.innerHTML += `<br><audio controls class="preview-audio"><source src="${e.target.result}" type="${file.type}"> æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾åŠŸèƒ½ã€‚<br>`;
      };
      reader.readAsDataURL(file);
      input.value = '';
    }

    // æ¶‚é¸¦åŠŸèƒ½
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let drawing = false;
    canvas.addEventListener("mousedown", () => drawing = true);
    canvas.addEventListener("mouseup", () => drawing = false);
    canvas.addEventListener("mouseout", () => drawing = false);
    canvas.addEventListener("mousemove", draw);

    function draw(e) {
      if (!drawing) return;
      ctx.fillStyle = "black";
      ctx.beginPath();
      ctx.arc(e.offsetX, e.offsetY, 2, 0, Math.PI * 2);
      ctx.fill();
    }

    function insertDoodle() {
      const content = document.getElementById("diary-content");
      const dataURL = canvas.toDataURL();
      content.innerHTML += `<br><img src="${dataURL}" class="preview-img"><br>`;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ‘çš„çµæ„Ÿæ—¥è®°</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      /* æ–°é£æ ¼ï¼šæŸ”å’Œçš„ç±³è‰²èƒŒæ™¯ï¼Œç±»ä¼¼çº¸å¼  */
      font-family: 'Noto Serif SC', serif;
      background: #f9f6f2;
      color: #3d3a37;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #ffffff;
      /* æ–°é£æ ¼ï¼šä½¿ç”¨æ›´æŸ”å’Œã€æ›´æµ…çš„é˜´å½± */
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #eee;
    }

    .header {
      /* æ–°é£æ ¼ï¼šæ¸©æš–çš„èµ¤é™¶è‰²ï¼Œæ›´æœ‰æ‰‹å¸æ„Ÿ */
      background: #c9aE9C;
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.2em;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .content {
      padding: 30px 40px;
    }

    /* ä¼˜åŒ–ï¼šä¸å†ä½¿ç”¨ç”Ÿç¡¬çš„å¡ç‰‡ç½‘æ ¼ï¼Œæ”¹ä¸ºæ›´æµç•…çš„å…ƒä¿¡æ¯æ  */
    .meta-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      padding: 20px;
      background: #fdfaf6;
      border-radius: 8px;
      margin-bottom: 30px;
      border: 1px solid #eee;
    }

    .meta-item {
      flex: 1 1 200px;
    }

    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #5a5652;
      margin-bottom: 8px;
      font-size: 0.95em;
    }

    input[type="datetime-local"],
    input[type="text"],
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1em;
      font-family: 'Noto Serif SC', serif;
      background: white;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #a38b7f;
      box-shadow: 0 0 0 3px rgba(163, 139, 127, 0.1);
    }

    /* æ–°å¢ï¼šå…ƒä¿¡æ¯æ çš„å°æŒ‰é’® */
    .meta-button {
      padding: 6px 10px;
      font-size: 0.85em;
      border: 1px solid #c9aE9C;
      color: #c9aE9C;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      margin-left: 8px;
      transition: all 0.2s;
    }
    .meta-button:hover {
      background: #c9aE9C;
      color: white;
    }
    
    .meta-input-group {
      display: flex;
      align-items: center;
    }
    .meta-input-group input, .meta-input-group select {
      flex-grow: 1;
    }
    .meta-input-group .meta-button {
      flex-shrink: 0;
      margin-left: 8px;
      padding: 12px;
      line-height: 1;
    }

    #diary-content {
      min-height: 300px;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      background: #fafafa;
      font-size: 1.05em;
      line-height: 1.7;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    #diary-content:focus {
      outline: none;
      border-color: #a38b7f;
      background: white;
      box-shadow: 0 0 0 3px rgba(163, 139, 127, 0.1);
    }

    /* ä¼˜åŒ–ï¼šå·¥å…·æ ä¸å†æ˜¯ç”Ÿç¡¬çš„æ–¹æ¡†ï¼Œè€Œæ˜¯æ›´èåˆçš„åŒºåŸŸ */
    .toolbar {
      padding: 20px 0;
      margin-bottom: 25px;
      border-top: 1px solid #eee;
      border-bottom: 1px solid #eee;
    }

    .toolbar-section {
      margin-bottom: 20px;
    }
    .toolbar-section:last-child { margin-bottom: 0; }

    .toolbar-label {
      font-weight: 600;
      color: #5a5652;
      margin-bottom: 12px;
      display: block;
    }
    
    .toolbar-inline-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95em;
      font-family: 'Noto Serif SC', serif;
      transition: all 0.3s;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    /* ä¼˜åŒ–ï¼šè¡¨æƒ…æŒ‰é’®æ›´æŸ”å’Œ */
    .btn-emoji {
      background: none;
      font-size: 1.6em;
      padding: 5px;
      border-radius: 8px;
    }
    .btn-emoji:hover {
      background: #f0ebe8;
      transform: scale(1.1);
    }

    /* æ–°é£æ ¼ï¼šä¸»è‰²è°ƒæŒ‰é’® */
    .btn-primary {
      background: #799c8a; /* æŸ”å’Œçš„ç»¿è‰² */
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(121, 156, 138, 0.2);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(121, 156, 138, 0.3);
    }

    /* æ–°é£æ ¼ï¼šæ¬¡è¦æŒ‰é’® */
    .btn-secondary {
      background: #f5f5f5;
      color: #555;
      border: 1px solid #ddd;
    }
    .btn-secondary:hover {
      background: #e9e9e9;
      border-color: #ccc;
    }
    
    /* æ–°é£æ ¼ï¼šå·¥å…·æŒ‰é’®ï¼ˆç”»ç¬”ã€æ©¡çš®ï¼‰ */
    .btn-tool {
      background: #f5f5f5;
      color: #555;
      border: 1px solid #ddd;
      padding: 8px 15px;
    }
    .btn-tool.active {
      background: #799c8a;
      color: white;
      border-color: #799c8a;
      box-shadow: 0 2px 5px rgba(121, 156, 138, 0.2);
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }
    .file-input-wrapper input[type="file"] { display: none; }
    .file-input-wrapper .btn { margin: 0; }

    #canvas {
      border: 1px dashed #ccc;
      border-radius: 8px;
      cursor: crosshair;
      display: block;
      margin: 15px 0;
      background: white;
    }

    .canvas-tools {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .color-picker {
      width: 40px;
      height: 40px;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      padding: 0;
    }
    
    .brush-size {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brush-size input[type="range"] { width: 120px; }

    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    /* ä¼˜åŒ–ï¼šæ—¥è®°åˆ—è¡¨æ¡ç›®æ–°é£æ ¼ */
    .diary-list {
      margin-top: 30px;
      padding-top: 30px;
      border-top: 1px solid #eee;
    }

    .diary-item {
      background: #fdfaf6;
      padding: 20px;
      border: 1px solid #eee;
      border-radius: 8px;
      margin-bottom: 15px;
      transition: box-shadow 0.3s;
    }
    .diary-item:hover {
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .diary-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .diary-item-meta {
      font-size: 0.9em;
      color: #666;
      font-family: Arial, sans-serif; /* å…ƒæ•°æ®ç”¨éè¡¬çº¿ä½“æ›´æ¸…æ™° */
    }
    .diary-item-content {
      line-height: 1.7;
      color: #333;
      overflow-wrap: break-word;
    }
    .diary-item-content img, .diary-item-content audio {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    
    /* åª’ä½“é¢„è§ˆæ ·å¼ */
    .preview-img {
      max-width: 80%; /* ä¸æ’‘æ»¡ï¼Œæ›´ç¾è§‚ */
      border-radius: 8px;
      margin: 10px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid #eee;
    }
    .preview-audio {
      width: 100%;
      max-width: 400px;
      margin: 10px 0;
    }

    /* è¾…åŠ©åŠŸèƒ½ */
    .save-status {
      text-align: center;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }
    .save-status.success {
      background: #e6f3eC;
      color: #4a7c59;
      display: block;
    }
    
    .help-text {
      font-size: 0.85em;
      color: #888;
      margin-top: 5px;
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“” æˆ‘çš„çµæ„Ÿæ—¥è®°</h1>
      <p>è®°å½•ç”Ÿæ´»çš„æ¸©åº¦ä¸è‰²å½©</p>
    </div>

    <div class="content">
      
      <div class="meta-bar">
        <div class="meta-item">
          <label>ğŸ“… æ—¶é—´</label>
          <div class="meta-input-group">
            <input type="datetime-local" id="time">
            <button class="meta-button" id="useCurrentTimeBtn" title="ä½¿ç”¨å½“å‰æ—¶é—´">ğŸ•’</button>
          </div>
        </div>

        <div class="meta-item">
          <label>ğŸ“ åœ°ç‚¹</label>
          <div class="meta-input-group">
            <input type="text" id="location" placeholder="è¯·è¾“å…¥åœ°ç‚¹">
            <button class="meta-button" id="getLocationBtn" title="è·å–å½“å‰ä½ç½®">ğŸŒ</button>
          </div>
          <p class="help-text">æç¤º: è·å–ä½ç½®åï¼Œå¯ <a id="windyLink" href="https://www.https://openweathermap.org" target="_blank">æŸ¥çœ‹openweathermap.orgå¤©æ°”</a></p>
        </div>

        <div class="meta-item">
          <label>ğŸŒ¤ï¸ å¤©æ°” (è‡ªåŠ¨)</label>
          <div class="meta-input-group">
            <select id="weather">
              <option>â˜€ï¸ æ™´å¤©</option>
              <option>â›… å¤šäº‘</option>
              <option>ğŸŒ§ï¸ é›¨å¤©</option>
              <option>ğŸŒ¨ï¸ é›ªå¤©</option>
              <option>ğŸŒ«ï¸ é›¾å¤©</option>
              <option>â›ˆï¸ é›·é›¨</option>
            </select>
            <button class="meta-button" id="getWeatherBtn" title="æ ¹æ®ä½ç½®è‡ªåŠ¨è·å–">ğŸ›°ï¸</button>
          </div>
        </div>
        
        <div class="meta-item">
          <label>ğŸ˜Š å¿ƒæƒ…</label>
          <select id="mood">
            <option>ğŸ˜Š å¼€å¿ƒ</option>
            <option>ğŸ˜” éš¾è¿‡</option>
            <option>ğŸ˜  ç”Ÿæ°”</option>
            <option>ğŸ˜Œ å¹³é™</option>
            <option>ğŸ˜ å…´å¥‹</option>
            <option>ğŸ˜´ ç–²æƒ«</option>
            <option>ğŸ¤” æ€è€ƒ</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>âœï¸ ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆ...</label>
        <div id="diary-content" contenteditable="true" placeholder="å†™ä¸‹ä½ çš„æ•…äº‹..."></div>
      </div>

      <div class="toolbar">
        <div class="toolbar-section">
          <span class="toolbar-label">ğŸ˜€ è¡¨æƒ…ç¬¦å·</span>
          <div class="toolbar-inline-group">
            <button class="btn btn-emoji" onclick="insertEmoji('ğŸ˜Š')">ğŸ˜Š</button>
            <button class="btn btn-emoji" onclick="insertEmoji('ğŸ˜¢')">ğŸ˜¢</button>
            <button class="btn btn-emoji" onclick="insertEmoji('â¤ï¸')">â¤ï¸</button>
            <button class="btn btn-emoji" onclick="insertEmoji('ğŸ‘')">ğŸ‘</button>
            <button class="btn btn-emoji" onclick="insertEmoji('ğŸ‰')">ğŸ‰</button>
            <button class="btn btn-emoji" onclick="insertEmoji('ğŸŒŸ')">ğŸŒŸ</button>
            <button class="btn btn-emoji" onclick="insertEmoji('â˜•')">â˜•</button>
            <button class="btn btn-emoji" onclick="insertEmoji('ğŸµ')">ğŸµ</button>
          </div>
        </div>

        <div class="toolbar-section">
          <span class="toolbar-label">ğŸ“ é™„ä»¶</span>
          <div class="toolbar-inline-group">
            <div class="file-input-wrapper">
              <label for="imageInput" class="btn btn-secondary">ğŸ“· æ’å…¥å›¾ç‰‡</label>
              <input type="file" id="imageInput" accept="image/*" onchange="insertImage()" />
            </div>
            <div class="file-input-wrapper">
              <label for="audioInput" class="btn btn-secondary">ğŸ¤ æ’å…¥è¯­éŸ³</label>
              <input type="file" id="audioInput" accept="audio/*" onchange="insertAudio()" />
            </div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>ğŸ¨ çµæ„Ÿç”»æ¿</label>
        <div class="canvas-tools">
          <button class="btn btn-tool active" id="penToolBtn">âœï¸ ç”»ç¬”</button>
          <button class="btn btn-tool" id="eraserToolBtn">ğŸ§¼ æ©¡çš®</button>
          
          <input type="color" id="colorPicker" class="color-picker" value="#000000">
          
          <div class="brush-size">
            <span>ç²—ç»†:</span>
            <input type="range" id="brushSize" min="1" max="20" value="2">
            <span id="brushSizeValue">2</span>
          </div>
          <button class="btn btn-secondary" onclick="clearCanvas()">ğŸ—‘ï¸ æ¸…ç©º</button>
          <button class="btn btn-primary" onclick="insertDoodle()">âœ… æ’å…¥ç”»æ¿</button>
        </div>
        <canvas id="canvas" width="800" height="300"></canvas>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" onclick="saveDiary()" style="font-size: 1.1em; padding: 15px 40px;">ğŸ’¾ ä¿å­˜æ—¥è®°</button>
        <button class="btn btn-secondary" onclick="clearForm()">ğŸ”„ æ¸…ç©ºé‡å†™</button>
        <button class="btn btn-secondary" onclick="exportDiary()">ğŸ“¤ å¯¼å‡ºæ—¥è®° (JSON)</button>
      </div>

      <div class="save-status" id="saveStatus"></div>

      <div class="diary-list" id="diaryList"></div>
    </div>
  </div>

  <script>
    let currentCoords = null; // ç”¨äºå­˜å‚¨ç»çº¬åº¦
    const OWM_API_KEY = "a5f12f5f57ba2db66cd4c6dfd4c6dbeb";
    // --- æ¶‚é¸¦æ¿å¢å¼º ---
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let drawing = false;
    let isErasing = false; // æ–°å¢ï¼šæ©¡çš®æ“¦çŠ¶æ€
    const penToolBtn = document.getElementById("penToolBtn");
    const eraserToolBtn = document.getElementById("eraserToolBtn");
    
    // åˆå§‹åŒ–
    window.onload = () => {
      setCurrentTime();
      loadDiaries();
      
      // ç”»ç¬”å¤§å°æ˜¾ç¤º
      const brushSizeSlider = document.getElementById("brushSize");
      const brushSizeValue = document.getElementById("brushSizeValue");
      brushSizeSlider.addEventListener("input", (e) => {
        brushSizeValue.textContent = e.target.value;
      });

      // æ–°å¢ï¼šè®¾ç½®å½“å‰æ—¶é—´æŒ‰é’®
      document.getElementById("useCurrentTimeBtn").onclick = setCurrentTime;
      
      // æ–°å¢ï¼šè·å–ä½ç½®æŒ‰é’®
      document.getElementById("getLocationBtn").onclick = getCurrentLocation;
      
      // æ–°å¢ï¼šè·å–å¤©æ°”æŒ‰é’® (APIå ä½)
      document.getElementById("getWeatherBtn").onclick = fetchWeather;
      
      // æ–°å¢ï¼šç”»ç¬”å·¥å…·åˆ‡æ¢
      penToolBtn.onclick = () => {
        isErasing = false;
        penToolBtn.classList.add("active");
        eraserToolBtn.classList.remove("active");
        canvas.style.cursor = 'crosshair';
      };
      eraserToolBtn.onclick = () => {
        isErasing = true;
        penToolBtn.classList.remove("active");
        eraserToolBtn.classList.add("active");
        canvas.style.cursor = 'cell'; // æ©¡çš®æ“¦å…‰æ ‡
      };
      
      // è°ƒæ•´Canvaså¤§å°ä»¥é€‚åº”å®¹å™¨
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
    };
    
    function resizeCanvas() {
        const contentWidth = canvas.parentElement.clientWidth;
        canvas.width = contentWidth - 2; // å‡å»è¾¹æ¡†
        canvas.height = 300; // å›ºå®šé«˜åº¦
    }

    function setCurrentTime() {
      const now = new Date();
      // ä¿®å¤æ—¶åŒºé—®é¢˜
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById("time").value = now.toISOString().slice(0, 16);
    }
    
    // --- æ–°å¢ï¼šåœ°ç†ä½ç½®åŠŸèƒ½ ---
    // è¿™ä¸ªæ–°ç‰ˆæœ¬ä¼šè·å–ç»çº¬åº¦ï¼Œç„¶åè°ƒç”¨ OpenWeatherMap API å°†å…¶è½¬æ¢ä¸ºåŸå¸‚å
    function getCurrentLocation() {
      const locInput = document.getElementById("location");
      const windyLink = document.getElementById("windyLink");
      
      if (!navigator.geolocation) {
        locInput.value = "æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®";
        return;
      }

      locInput.value = "æ­£åœ¨è·å–ä½ç½®...";
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          currentCoords = { lat, lon }; // å­˜å‚¨åæ ‡ä»¥ä¾› fetchWeather ä½¿ç”¨
          
          // æ›´æ–°Windy.comé“¾æ¥ (è¿™ä¸ªé“¾æ¥ä¸éœ€è¦API Keyï¼Œä»ç„¶å¯ç”¨)
          windyLink.href = `https://www.windy.com/?${lat},${lon},10`;
          
          // --- æ–°åŠŸèƒ½ï¼šä½¿ç”¨ OWM åå‘åœ°ç†ç¼–ç  API ---
          fetch(`https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${OWM_API_KEY}`)
            .then(res => {
                if (!res.ok) throw new Error(`Geocoding HTTP é”™è¯¯! çŠ¶æ€: ${res.status}`);
                return res.json();
            })
            .then(data => {
              if (data && data.length > 0) {
                // æˆåŠŸè·å–åŸå¸‚å
                const city = data[0].name;
                const country = data[0].country;
                locInput.value = `${city}, ${country}`;
                console.log("åŸå¸‚è¯†åˆ«æˆåŠŸ:", data[0]);
              } else {
                locInput.value = `çº¬åº¦: ${lat.toFixed(4)}, ç»åº¦: ${lon.toFixed(4)}`;
              }
            })
            .catch(err => {
              console.error("åå‘åœ°ç†ç¼–ç APIè¯·æ±‚å¤±è´¥:", err);
              alert(`è·å–åŸå¸‚åç§°å¤±è´¥ã€‚\nè¯·æ£€æŸ¥API Keyæ˜¯å¦æ­£ç¡®å¹¶å·²æ¿€æ´»ã€‚\né”™è¯¯: ${err.message}`);
              locInput.value = "è·å–åŸå¸‚å¤±è´¥";
            });
        },
        () => {
          locInput.value = "è·å–ä½ç½®å¤±è´¥";
        }
      );
    }
    
    // --- æ–°å¢ï¼šå¤©æ°”APIå ä½ ---
    // --- é‡å†™ä»¥é€‚é… Windy.com API ---
    function fetchWeather() {
        if (!currentCoords) {
            alert("è¯·å…ˆè·å–åœ°ç†ä½ç½®ï¼");
            return;
        }
        
        const lat = currentCoords.lat;
        const lon = currentCoords.lon;
        const weatherSelect = document.getElementById("weather");
        const originalValue = weatherSelect.value;
        
        // ä¸´æ—¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (!document.getElementById("loading-weather")) {
            weatherSelect.innerHTML += '<option id="loading-weather" value="loading">æ­£åœ¨è·å–å¤©æ°”...</option>';
        }
        weatherSelect.value = "loading";

        fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OWM_API_KEY}&units=metric&lang=zh_cn`)
          .then(res => {
              if (!res.ok) {
                  throw new Error(`Weather HTTP é”™è¯¯! çŠ¶æ€: ${res.status}`);
              }
              return res.json();
          })
          .then(data => {
            console.log("OWM å¤©æ°” API è¿”å›æ•°æ®:", data);
            
            if (data.weather && data.weather.length > 0) {
                const weatherDesc = data.weather[0].description; // "å°é›¨", "å¤šäº‘", "æ™´"
                console.log("è·å–åˆ°å¤©æ°”æè¿°:", weatherDesc); 
                
                const emojiValue = mapWeatherToEmoji(weatherDesc);
                weatherSelect.value = emojiValue;
            } else {
                console.error("å¤©æ°”æ•°æ®æ ¼å¼ä¸æ­£ç¡®:", data);
                weatherSelect.value = originalValue; // æ¢å¤åŸå€¼
            }
          })
          .catch(err => {
              console.error("å¤©æ°”APIè¯·æ±‚å¤±è´¥:", err);
              alert(`è·å–å¤©æ°”å¤±è´¥ã€‚\nè¯·æ£€æŸ¥API Keyæ˜¯å¦æ­£ç¡®å¹¶å·²æ¿€æ´»ã€‚\né”™è¯¯: ${err.message}`);
              weatherSelect.value = originalValue; // æ¢å¤åŸå€¼
          })
          .finally(() => {
              // æ— è®ºæˆåŠŸä¸å¦ï¼Œéƒ½ç§»é™¤åŠ è½½é€‰é¡¹
              const loadingOption = document.getElementById("loading-weather");
              if (loadingOption) {
                  loadingOption.remove();
              }
          });
    }

    // --- æ–°å¢çš„å¤©æ°”æ˜ å°„å‡½æ•° (Windy.com ç‰ˆ) ---
    // (è¯·å°†æ­¤å‡½æ•°æ·»åŠ åˆ° <script> æ ‡ç­¾å†…)
    function mapWeatherToEmoji(description) {
        const desc = description.toLowerCase();
        console.log(`æ­£åœ¨åŒ¹é…æè¿°: ${desc}`);

        // è¿™é‡Œçš„è¿”å›å€¼å¿…é¡»ä¸ä½  <select id="weather"> 
        // ä¸­çš„ <option> æ–‡æœ¬å®Œå…¨ä¸€è‡´ã€‚
        
        if (desc.includes('é›·') || desc.includes('æš´')) {
            return 'â›ˆï¸ é›·é›¨';
        }
        if (desc.includes('é›ª')) {
            return 'ğŸŒ¨ï¸ é›ªå¤©';
        }
        if (desc.includes('é›¨')) {
            return 'ğŸŒ§ï¸ é›¨å¤©';
        }
        if (desc.includes('é›¾') || desc.includes('éœ¾') || desc.includes('è–„é›¾')) {
            return 'ğŸŒ«ï¸ é›¾å¤©';
        }
        if (desc.includes('äº‘')) {
            return 'â›… å¤šäº‘';
        }
        if (desc.includes('æ™´')) {
            return 'â˜€ï¸ æ™´å¤©';
        }
        
        // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œé»˜è®¤è¿”å›ç¬¬ä¸€ä¸ªé€‰é¡¹
        console.warn(`æœªæ‰¾åˆ°åŒ¹é…çš„å¤©æ°”æè¿°: ${desc}ï¼Œè¿”å›é»˜è®¤å€¼ã€‚`);
        return 'â˜€ï¸ æ™´å¤©'; 
    }

    // è¡¨æƒ…æ’å…¥
    function insertEmoji(emoji) {
      const content = document.getElementById("diary-content");
      content.focus();
      document.execCommand('insertHTML', false, emoji);
    }

    // å›¾ç‰‡æ’å…¥
    function insertImage() {
      const input = document.getElementById("imageInput");
      const file = input.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = document.getElementById("diary-content");
        content.focus();
        // æ’å…¥å›¾ç‰‡å¹¶æ¢è¡Œ
        document.execCommand('insertHTML', false, `<br><img src="${e.target.result}" class="preview-img"><br>`);
      };
      reader.readAsDataURL(file);
      input.value = '';
    }

    // è¯­éŸ³æ’å…¥
    function insertAudio() {
      const input = document.getElementById("audioInput");
      const file = input.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = document.getElementById("diary-content");
        content.focus();
        document.execCommand('insertHTML', false, `<br><audio controls class="preview-audio"><source src="${e.target.result}" type="${file.type}"></audio><br>`);
      };
      reader.readAsDataURL(file);
      input.value = '';
    }

    // --- æ¶‚é¸¦åŠŸèƒ½ (å·²æ›´æ–°æ”¯æŒæ©¡çš®æ“¦) ---
    canvas.addEventListener("mousedown", (e) => {
      drawing = true;
      draw(e);
    });
    canvas.addEventListener("mouseup", () => {
      drawing = false;
      ctx.beginPath(); // åœæ­¢ç”»çº¿
    });
    canvas.addEventListener("mouseout", () => drawing = false);
    canvas.addEventListener("mousemove", draw);

    // è§¦æ‘¸æ”¯æŒ
    canvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      drawing = true;
      const touch = e.touches[0];
      draw(getTouchPos(touch));
    });
    canvas.addEventListener("touchmove", (e) => {
      e.preventDefault();
      if (!drawing) return;
      const touch = e.touches[0];
      draw(getTouchPos(touch));
    });
    canvas.addEventListener("touchend", () => {
        drawing = false;
        ctx.beginPath();
    });
    
    function getTouchPos(touch) {
        const rect = canvas.getBoundingClientRect();
        return {
            offsetX: touch.clientX - rect.left,
            offsetY: touch.clientY - rect.top
        };
    }

    function draw(e) {
      if (!drawing) return;
      const color = document.getElementById("colorPicker").value;
      const size = document.getElementById("brushSize").value;
      
      // æ£€æŸ¥æ˜¯ç”»ç¬”è¿˜æ˜¯æ©¡çš®
      if (isErasing) {
        ctx.globalCompositeOperation = 'destination-out'; // æ©¡çš®æ“¦æ¨¡å¼
        ctx.lineWidth = size * 2; // æ©¡çš®æ“¦å¯ä»¥ç²—ä¸€ç‚¹
        ctx.strokeStyle = "rgba(0,0,0,1)"; // é¢œè‰²ä¸é‡è¦ï¼Œä½†å¿…é¡»è®¾ç½®
      } else {
        ctx.globalCompositeOperation = 'source-over'; // æ­£å¸¸ç»˜ç”»æ¨¡å¼
        ctx.lineWidth = size;
        ctx.strokeStyle = color;
      }
      
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    }

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function insertDoodle() {
      const content = document.getElementById("diary-content");
      const dataURL = canvas.toDataURL(); // è·å–PNGæ ¼å¼
      content.focus();
      document.execCommand('insertHTML', false, `<br><img src="${dataURL}" class="preview-img" alt="æ¶‚é¸¦"><br>`);
      clearCanvas();
    }

    // ä¿å­˜æ—¥è®°
    function saveDiary() {
      const diary = {
        id: Date.now(),
        time: document.getElementById("time").value,
        weather: document.getElementById("weather").value,
        mood: document.getElementById("mood").value,
        location: document.getElementById("location").value,
        // ä¿®å¤ï¼šä¿å­˜innerHTMLä»¥ä¿ç•™å¯Œæ–‡æœ¬
        content: document.getElementById("diary-content").innerHTML 
      };

      const diaries = JSON.parse(localStorage.getItem('diaries') || '[]');
      diaries.unshift(diary); // æ–°æ—¥è®°æ”¾åœ¨æœ€å‰é¢
      localStorage.setItem('diaries', JSON.stringify(diaries));

      showSaveStatus('âœ… æ—¥è®°ä¿å­˜æˆåŠŸï¼');
      loadDiaries();
      // å¯é€‰ï¼šä¿å­˜åæ¸…ç©ºè¡¨å•
      // clearForm(false); // ä¼ å…¥falseé¿å…äºŒæ¬¡ç¡®è®¤
    }

    // åŠ è½½æ—¥è®°åˆ—è¡¨
    function loadDiaries() {
      const diaries = JSON.parse(localStorage.getItem('diaries') || '[]');
      const listDiv = document.getElementById("diaryList");
      
      if (diaries.length === 0) {
        listDiv.innerHTML = '<p style="text-align:center; color:#888;">è¿˜æ²¡æœ‰å†å²æ—¥è®°å“¦ã€‚</p>';
        return;
      }

      listDiv.innerHTML = '<h2 style="margin-bottom: 20px; color: #333; font-weight: 600;">ğŸ“š å†å²æ—¥è®°</h2>';
      
      diaries.forEach(diary => {
        const date = new Date(diary.time);
        const dateStr = date.toLocaleString('zh-CN', { dateStyle: 'medium', timeStyle: 'short' });
        
        const item = document.createElement('div');
        item.className = 'diary-item';
        item.innerHTML = `
          <div class="diary-item-header">
            <div class="diary-item-meta">
              ğŸ“… ${dateStr} | ${diary.weather} | ${diary.mood} | ğŸ“ ${diary.location}
            </div>
            <button class="btn btn-secondary" style="padding: 5px 15px; margin: 0;" onclick="deleteDiary(${diary.id})">ğŸ—‘ï¸ åˆ é™¤</button>
          </div>
          <div class="diary-item-content">${diary.content}</div>
        `;
        listDiv.appendChild(item);
      });
    }

    // åˆ é™¤æ—¥è®°
    function deleteDiary(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿ')) return;
      
      const diaries = JSON.parse(localStorage.getItem('diaries') || '[]');
      const filtered = diaries.filter(d => d.id !== id);
      localStorage.setItem('diaries', JSON.stringify(filtered));
      loadDiaries();
    }

    // æ¸…ç©ºè¡¨å•
    function clearForm(confirmFirst = true) {
      if (confirmFirst && !confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰æ‰€æœ‰å†…å®¹å—ï¼Ÿ')) return;
      
      document.getElementById("diary-content").innerHTML = '';
      document.getElementById("location").value = '';
      clearCanvas();
      setCurrentTime(); // é‡ç½®ä¸ºå½“å‰æ—¶é—´
      // é‡ç½®ä¸‹æ‹‰èœå•
      document.getElementById("weather").selectedIndex = 0;
      document.getElementById("mood").selectedIndex = 0;
      currentCoords = null; // æ¸…é™¤åæ ‡
    }

    // --- ä¼˜åŒ–ï¼šå¯¼å‡ºæ—¥è®°åŠŸèƒ½ ---
    function exportDiary() {
      const diaryData = {
        // æ–°å¢ï¼šå…ƒæ•°æ®
        exportInfo: {
          appName: "æˆ‘çš„çµæ„Ÿæ‰‹å¸",
          version: "2.0",
          exportedAt: new Date().toISOString()
        },
        // æ ¸å¿ƒæ—¥è®°æ•°æ®
        diary: {
          id: `export_${Date.now()}`,
          time: document.getElementById("time").value,
          weather: document.getElementById("weather").value,
          mood: document.getElementById("mood").value,
          location: document.getElementById("location").value,
          // ä¿®å¤ï¼šå¯¼å‡ºinnerHTMLä»¥ä¿ç•™æ‰€æœ‰åª’ä½“
          contentHTML: document.getElementById("diary-content").innerHTML,
          // æ–°å¢ï¼šåŒæ—¶å¯¼å‡ºä¸€ä»½çº¯æ–‡æœ¬
          contentText: document.getElementById("diary-content").innerText
        }
      };

      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(diaryData, null, 2));
      const downloadAnchor = document.createElement('a');
      downloadAnchor.setAttribute("href", dataStr);
      downloadAnchor.setAttribute("download", `diary_${new Date(diaryData.diary.time).toISOString().slice(0,10)}.json`);
      downloadAnchor.click();
    }

    // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
    function showSaveStatus(message) {
      const status = document.getElementById('saveStatus');
      status.className = 'save-status success';
      status.textContent = message;
      setTimeout(() => {
        status.style.display = 'none';
      }, 3000);
    }
  </script>
</body>
</html>
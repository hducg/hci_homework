<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æˆ‘çš„å¤šåª’ä½“æ—¥è®°</title>
  <style>
    /* å…¨å±€æ ·å¼é‡ç½®ä¸åŸºç¡€è®¾ç½® */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Microsoft YaHei', 'Arial', sans-serif;
    }

    body {
      padding: 20px;
      background-color: #f7f9fc;
      max-width: 1200px;
      margin: 0 auto; /* å±…ä¸­å¸ƒå±€ */
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 30px;
      font-weight: 600;
    }

    .diary-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    .small-form-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .form-item {
      width: 100%;
    }

    label {
      display: block;
      margin-bottom: 6px;
      color: #34495e;
      font-weight: bold;
      font-size: 16px;
    }

    input, select, textarea {
      border-radius: 8px;
      border: 1px solid #d1d5db;
      width: 100%;
      padding: 10px 12px;
      margin-top: 2px;
      font-size: 15px;
      transition: border-color 0.3s;
    }

    input:focus, select:focus, #diary-content:focus {
      outline: none;
      border-color: #3b82f6; 
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    #weather, #mood {
      padding-right: 24px;
      position: relative;
      appearance: none; /* å»é™¤æµè§ˆå™¨é»˜è®¤ç®­å¤´ */
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center; /* ç®­å¤´ä½ç½®ï¼šå³8pxï¼Œå±…ä¸­ï¼ˆæ•°å€¼è¶Šå°è¶Šé å·¦ï¼‰ */
      background-size: 12px; /* ç®­å¤´å¤§å° */
    }

    #diary-content {
      min-height: 220px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 12px;
      background-color: white;
      line-height: 1.6;
      font-size: 15px;
      white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œå’Œç©ºæ ¼æ ¼å¼ */
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background-color: white;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      margin-bottom: 15px;
    }

    .toolbar label {
      margin-bottom: 0;
      color: #2c3e50;
    }

    .toolbar button, .draw-btn-group button {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background-color: white;
      color: #34495e;
      cursor: pointer;
      font-size: 14px;
      font-weight: medium;
      transition: all 0.2s;
    }

    .toolbar button:hover, .draw-btn-group button:hover {
      background-color: #f3f4f6;
      border-color: #94a3b8;
    }

    .upload {
      display: none;
    }

    .upload-label {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background-color: white;
      color: #34495e;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .upload-label:hover {
      background-color: #f3f4f6;
      border-color: #94a3b8;
    }

    .draw-section {
      background-color: white;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 15px;
      margin-bottom: 20px;
    }

    #canvas {
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      cursor: crosshair;
      width: 100%;
      height: auto; /* è‡ªé€‚åº”å®½åº¦ */
      max-width: 600px; /* æœ€å¤§å®½åº¦é™åˆ¶ */
      display: block;
      margin: 10px 0;
    }

    .draw-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    .draw-controls label{
      margin-top: 6px;
      font-size: 14px;
      font-weight: 500;
    }

    .color-picker, .size-select {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
    }

    .preview-img, .preview-audio {
      max-width: 100%;
      max-height: 400px; 
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }

    .preview-audio {
      width: 100%;
      padding: 8px;
    }

    /* åº•éƒ¨æ“ä½œæŒ‰é’® */
    .action-btns {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 30px;
    }

    .action-btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }

    #save-btn {
      background-color: #22c55e;
      color: white;
    }

    #save-btn:hover {
      background-color: #16a34a;
    }

    #clear-btn {
      background-color: #ef4444;
      color: white;
    }

    #clear-btn:hover {
      background-color: #dc2626;
    }

    /* æç¤ºå¼¹çª— */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 6px;
      background-color: #10b981;
      color: white;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
    }

    .toast.show {
      opacity: 1;
    }

    /* å“åº”å¼é€‚é…ï¼šå°å±å¹•ä¼˜åŒ– */
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }

      .small-form-group {
        grid-template-columns: 1fr; /* å°å±å¹•å•åˆ—å¸ƒå±€ */
      }

      .action-btn {
        padding: 10px 18px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <h1>æˆ‘çš„å¤šåª’ä½“æ—¥è®°</h1>

  <!-- æç¤ºå¼¹çª— -->
  <div class="toast" id="toast"></div>

  <div class="diary-container">
    <!-- å°è¡¨å•ç»„ï¼šæ ‡é¢˜/æ—¶é—´/å¤©æ°”/å¿ƒæƒ…/åœ°ç‚¹ -->
    <div class="small-form-group">
      <div class="form-item">
        <label>æ ‡é¢˜:</label>
        <input type="text" id="title" placeholder="è¯·è¾“å…¥æ—¥è®°æ ‡é¢˜">
      </div>
      <div class="form-item">
        <label>æ—¶é—´:</label>
        <input type="datetime-local" id="time">
      </div>
      <div class="form-item">
        <label>å¤©æ°”:</label>
        <select id="weather">
          <option>â˜€ï¸ æ™´</option>
          <option>â›… å¤šäº‘</option>
          <option>ğŸŒ§ï¸ é›¨</option>
          <option>ğŸŒ¨ï¸ é›ª</option>
          <option>ğŸŒ«ï¸ é›¾</option>
          <option>ğŸŒ¬ï¸ é£</option>
        </select>
      </div>
      <div class="form-item">
        <label>å¿ƒæƒ…:</label>
        <select id="mood">
          <option>ğŸ˜Š å¼€å¿ƒ</option>
          <option>ğŸ˜Œ å¹³é™</option>
          <option>ğŸ˜” éš¾è¿‡</option>
          <option>ğŸ˜  ç”Ÿæ°”</option>
          <option>ğŸ¥³ å…´å¥‹</option>
          <option>ğŸ˜´ ç–²æƒ«</option>
        </select>
      </div>
      <div class="form-item">
        <label>åœ°ç‚¹:</label>
        <input type="text" id="location" placeholder="è¯·è¾“å…¥åœ°ç‚¹">
      </div>
    </div>

    <!-- æ—¥è®°å†…å®¹ç¼–è¾‘åŒº -->
    <div class="form-item">
      <label>äº‹ä»¶ä¸æ„Ÿæƒ³:</label>
      <div id="diary-content" contenteditable="true" placeholder="åœ¨è¿™é‡Œè®°å½•ä½ çš„æ•…äº‹å§..."></div>
    </div>

    <!-- æ’å…¥å·¥å…·æ  -->
    <div class="toolbar">
      <label>æ’å…¥å†…å®¹ï¼š</label>
      <!-- è¡¨æƒ…æŒ‰é’® -->
      <button onclick="insertEmoji('ğŸ˜Š')">ğŸ˜Š</button>
      <button onclick="insertEmoji('â¤ï¸')">â¤ï¸</button>
      <button onclick="insertEmoji('ğŸ‰')">ğŸ‰</button>
      <button onclick="insertEmoji('ğŸ“¸')">ğŸ“¸</button>
      <button onclick="insertEmoji('ğŸµ')">ğŸµ</button>
      <!-- å›¾ç‰‡ä¸Šä¼  -->
      <label for="imageInput" class="upload-label">ğŸ“· æ’å…¥å›¾ç‰‡</label>
      <input type="file" id="imageInput" accept="image/*" onchange="insertImage()" class="upload"/>
      <!-- éŸ³é¢‘ä¸Šä¼  -->
      <label for="audioInput" class="upload-label">ğŸ§ æ’å…¥éŸ³é¢‘</label>
      <input type="file" id="audioInput" accept="audio/*" onchange="insertAudio()" class="upload"/>
    </div>

    <!-- æ¶‚é¸¦åŒºåŸŸ -->
    <div class="draw-section">
      <label>æ¶‚é¸¦æ¿:</label>
      <!-- æ¶‚é¸¦æ§åˆ¶é¡¹ -->
      <div class="draw-controls">
        <label>é¢œè‰²:</label>
        <input type="color" id="draw-color" class="color-picker" value="#000000">
        <label>ç”»ç¬”ç²—ç»†:</label>
        <select id="draw-size" class="size-select">
          <option value="2">ç»†ï¼ˆ2pxï¼‰</option>
          <option value="4" selected>ä¸­ï¼ˆ4pxï¼‰</option>
          <option value="6">ç²—ï¼ˆ6pxï¼‰</option>
          <option value="8">ç‰¹ç²—ï¼ˆ8pxï¼‰</option>
        </select>
      </div>
      <!-- æ¶‚é¸¦ç”»å¸ƒ -->
      <canvas id="canvas" width="800" height="400"></canvas>
      <!-- æ¶‚é¸¦æ“ä½œæŒ‰é’® -->
      <div class="draw-btn-group">
        <button onclick="clearCanvas()">æ¸…ç©ºç”»å¸ƒ</button>
        <button onclick="insertDoodle()">æ’å…¥æ¶‚é¸¦åˆ°æ—¥è®°</button>
      </div>
    </div>

    <!-- åº•éƒ¨æ“ä½œæŒ‰é’®ï¼šä¿å­˜/æ¸…ç©º -->
    <div class="action-btns">
      <button class="action-btn" id="save-btn" onclick="saveDiary()">ä¿å­˜æ—¥è®°</button>
      <button class="action-btn" id="clear-btn" onclick="clearDiary()">æ¸…ç©ºå†…å®¹</button>
    </div>
  </div>

  <script>
    // åˆå§‹åŒ–å½“å‰æ—¶é—´
    window.onload = () => {
      const now = new Date();
      // ä¿®å¤æ—¶åŒºåå·®
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0'); 
      const day = String(now.getDate()).padStart(2, '0');
      const hour = String(now.getHours()).padStart(2, '0');
      const minute = String(now.getMinutes()).padStart(2, '0');
      const localTime = `${year}-${month}-${day}T${hour}:${minute}`;
      document.getElementById("time").value = localTime;
      
      initDrawing(); // åˆå§‹åŒ–æ¶‚é¸¦
    };

    // è¡¨æƒ…æ’å…¥åŠŸèƒ½
    function insertEmoji(emoji) {
      const content = document.getElementById("diary-content");
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        // è·å–å½“å‰å…‰æ ‡ä½ç½®
        const range = selection.getRangeAt(0);
        // åˆ›å»ºè¡¨æƒ…æ–‡æœ¬èŠ‚ç‚¹
        const emojiNode = document.createTextNode(emoji);
        // åœ¨å…‰æ ‡ä½ç½®æ’å…¥è¡¨æƒ…
        range.insertNode(emojiNode);
        // ç§»åŠ¨å…‰æ ‡åˆ°è¡¨æƒ…åé¢
        range.setStartAfter(emojiNode);
        range.setEndAfter(emojiNode);
        selection.removeAllRanges();
        selection.addRange(range);
      } else {
        content.innerHTML += emoji;
      }
      // èšç„¦å›ç¼–è¾‘åŒº
      content.focus();
    }

    // å›¾ç‰‡æ’å…¥åŠŸèƒ½
    function insertImage() {
      const input = document.getElementById("imageInput");
      const file = input.files[0];
      if (!file) return;

      // é™åˆ¶å›¾ç‰‡å¤§å°ï¼ˆæœ€å¤§5MBï¼‰
      const maxSize = 5 * 1024 * 1024;
      if (file.size > maxSize) {
        showToast("å›¾ç‰‡å¤§å°è¶…è¿‡5MBï¼Œè¯·é€‰æ‹©æ›´å°çš„å›¾ç‰‡");
        input.value = ""; // æ¸…ç©ºé€‰æ‹©
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const content = document.getElementById("diary-content");
        // æ’å…¥å›¾ç‰‡å¹¶æ·»åŠ altå±æ€§å’Œç»Ÿä¸€æ ·å¼
        content.innerHTML += `<br><img src="${e.target.result}" class="preview-img" alt="æ’å…¥çš„å›¾ç‰‡"><br>`;
        input.value = ""; // æ¸…ç©ºé€‰æ‹©ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€å¼ å›¾
      };
      reader.readAsDataURL(file);
    }

    // éŸ³é¢‘æ’å…¥åŠŸèƒ½
    function insertAudio() {
      const input = document.getElementById("audioInput");
      const file = input.files[0];
      if (!file) return;

      // é™åˆ¶éŸ³é¢‘å¤§å°ï¼ˆæœ€å¤§10MBï¼‰
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        showToast("éŸ³é¢‘å¤§å°è¶…è¿‡10MBï¼Œè¯·é€‰æ‹©æ›´å°çš„éŸ³é¢‘");
        input.value = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const content = document.getElementById("diary-content");
        // æ’å…¥éŸ³é¢‘æ’­æ”¾å™¨å¹¶æ·»åŠ æµè§ˆå™¨ä¸æ”¯æŒæç¤º
        content.innerHTML += `<br><audio controls class="preview-audio"><source src="${e.target.result}" type="${file.type}">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾</audio><br>`;
        input.value = "";
      };
      reader.readAsDataURL(file);
    }

    // æ¶‚é¸¦åŠŸèƒ½
    let drawing = false;
    let lastX = 0;
    let lastY = 0;
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const colorPicker = document.getElementById("draw-color");
    const sizeSelect = document.getElementById("draw-size");

    function initDrawing() {
      // ç”»å¸ƒé€‚é…å±å¹•å®½åº¦
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

      // é¼ æ ‡äº‹ä»¶ç›‘å¬
      canvas.addEventListener("mousedown", startDraw);
      canvas.addEventListener("mousemove", draw);
      canvas.addEventListener("mouseup", endDraw);
      canvas.addEventListener("mouseout", endDraw);
      // è§¦æ‘¸äº‹ä»¶ç›‘å¬ï¼ˆé€‚é…æ‰‹æœºï¼‰
      canvas.addEventListener("touchstart", startDrawTouch);
      canvas.addEventListener("touchmove", drawTouch);
      canvas.addEventListener("touchend", endDraw);
    }

    // ç”»å¸ƒè‡ªé€‚åº” resize
    function resizeCanvas() {
      const containerWidth = canvas.parentElement.clientWidth;
      const ratio = canvas.height / canvas.width; // ä¿æŒå®½é«˜æ¯”
      canvas.width = Math.min(containerWidth - 30, 800); // å‡å»padding
      canvas.height = canvas.width * ratio;
    }

    // å¼€å§‹ç»˜ç”»ï¼ˆé¼ æ ‡ï¼‰
    function startDraw(e) {
      drawing = true;
      [lastX, lastY] = [getCanvasX(e), getCanvasY(e)];
    }

    // å¼€å§‹ç»˜ç”»ï¼ˆè§¦æ‘¸ï¼‰
    function startDrawTouch(e) {
      e.preventDefault(); // é˜»æ­¢æ»šåŠ¨
      const touch = e.touches[0];
      drawing = true;
      [lastX, lastY] = [getCanvasX(touch), getCanvasY(touch)];
    }

    // ç»˜ç”»é€»è¾‘
    function draw(e) {
      if (!drawing) return;
      const currentX = getCanvasX(e);
      const currentY = getCanvasY(e);
      
      ctx.beginPath();
      ctx.strokeStyle = colorPicker.value; // ç”»ç¬”é¢œè‰²
      ctx.lineWidth = sizeSelect.value; // ç”»ç¬”ç²—ç»†
      ctx.lineCap = "round"; // åœ†è§’ç¬”è§¦
      ctx.lineJoin = "round"; // åœ†è§’è¿æ¥
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(currentX, currentY);
      ctx.stroke();
      
      [lastX, lastY] = [currentX, currentY];
    }

    // è§¦æ‘¸ç»˜ç”»
    function drawTouch(e) {
      if (!drawing) return;
      e.preventDefault();
      const touch = e.touches[0];
      const currentX = getCanvasX(touch);
      const currentY = getCanvasY(touch);
      
      ctx.beginPath();
      ctx.strokeStyle = colorPicker.value;
      ctx.lineWidth = sizeSelect.value;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(currentX, currentY);
      ctx.stroke();
      
      [lastX, lastY] = [currentX, currentY];
    }

    function endDraw() {
      drawing = false;
    }

    function getCanvasX(e) {
      const rect = canvas.getBoundingClientRect();
      return (e.clientX - rect.left) * (canvas.width / rect.width);
    }

    function getCanvasY(e) {
      const rect = canvas.getBoundingClientRect();
      return (e.clientY - rect.top) * (canvas.height / rect.height);
    }

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function insertDoodle() {
      const content = document.getElementById("diary-content");
      const dataURL = canvas.toDataURL("image/png", 0.8);
      content.innerHTML += `<br><img src="${dataURL}" class="preview-img" alt="æ¶‚é¸¦ä½œå“"><br>`;
      clearCanvas(); 
      showToast("æ¶‚é¸¦å·²æ’å…¥æ—¥è®°");
    }

    function saveDiary() {
      const title = document.getElementById("title").value.trim();
      const time = document.getElementById("time").value;
      const weather = document.getElementById("weather").value;
      const mood = document.getElementById("mood").value;
      const location = document.getElementById("location").value.trim();
      const content = document.getElementById("diary-content").innerHTML.trim();

      if (!title) {
        showToast("è¯·è¾“å…¥æ—¥è®°æ ‡é¢˜");
        return;
      }
      if (!time) {
        showToast("è¯·é€‰æ‹©æ—¥è®°æ—¶é—´");
        return;
      }
      if (!content) {
        showToast("è¯·å¡«å†™æ—¥è®°å†…å®¹");
        return;
      }

      const diaryData = {
        id: Date.now(), // å”¯ä¸€IDï¼ˆæ—¶é—´æˆ³ï¼‰
        title,
        time,
        weather,
        mood,
        location,
        content,
        saveTime: new Date().toISOString() // ä¿å­˜æ—¶é—´
      };


      let savedDiaries = JSON.parse(localStorage.getItem("multiMediaDiaries") || "[]");
      savedDiaries.push(diaryData);

      localStorage.setItem("multiMediaDiaries", JSON.stringify(savedDiaries));

      showToast(`æ—¥è®°ã€Š${title}ã€‹ä¿å­˜æˆåŠŸï¼`);
      // clearDiary(false);
    }

    function clearDiary(showTip = true) {
      document.getElementById("title").value = "";
      document.getElementById("time").value = new Date().toISOString().slice(0, 16);
      document.getElementById("weather").value = "â˜€ï¸ æ™´";
      document.getElementById("mood").value = "ğŸ˜Š å¼€å¿ƒ";
      document.getElementById("location").value = "";
      document.getElementById("diary-content").innerHTML = "";
      clearCanvas();

      if (showTip) {
        showToast("å·²æ¸…ç©ºæ‰€æœ‰å†…å®¹");
      }
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.add("show");
      // 3ç§’åéšè—
      setTimeout(() => {
        toast.classList.remove("show");
      }, 3000);
    }
  </script>
</body>
</html>